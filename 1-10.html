<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Minecraft: Happy Birthday Max!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'VT323', monospace; user-select: none; }
        #hud { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 24px; height: 24px; transform: translate(-50%, -50%); mix-blend-mode: difference; }
        #crosshair::before { content: ''; position: absolute; top: 11px; left: 0; width: 24px; height: 2px; background: white; }
        #crosshair::after { content: ''; position: absolute; top: 0; left: 11px; width: 2px; height: 24px; background: white; }
        
        #bday-card {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95); border: 8px solid #ff55ff; padding: 40px;
            text-align: center; border-radius: 20px; box-shadow: 0 0 50px #fff; pointer-events: auto; z-index: 1000;
        }
        #card-text { font-size: 50px; color: #ff00aa; text-shadow: 2px 2px 0 #000; }
        #card-sub { font-size: 30px; color: #555; margin-top: 20px; }
        
        #bottom-ui { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 600px; text-align: center; }
        #hotbar { display: flex; justify-content: center; gap: 4px; background: rgba(0,0,0,0.6); padding: 5px; border: 2px solid #fff; border-radius: 4px; }
        .slot { width: 60px; height: 60px; background: #8b8b8b; border: 4px solid #373737; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; }
        .slot.active { border-color: white; background: #a0a0a0; }
    </style>
</head>
<body>

<div id="hud">
    <div id="bday-card">
        <div id="card-text">You are the best!</div>
        <div id="card-sub">May all your dreams come true! üéÇ‚ú®</div>
        <button onclick="document.getElementById('bday-card').style.display='none'; document.body.requestPointerLock();" style="margin-top:20px; font-family:'VT323'; font-size:24px; cursor:pointer; background:#ff55ff; color:white; border:none; padding:10px 20px;">CLOSE</button>
    </div>
    <div id="crosshair"></div>
    <div id="bottom-ui">
        <div id="hotbar">
            <div class="slot active" id="slot-0">üî´</div>
            <div class="slot" id="slot-1">üó°Ô∏è</div>
        </div>
    </div>
</div>

<script>
let scene, camera, renderer, weaponGroup, balloonGift;
let targets = [], particles = [], houses = [];
let move = { fwd: false, bwd: false, left: false, right: false, jump: false };
let player = { vel: new THREE.Vector3(), onGround: false, height: 1.7 };
let pitch = 0, yaw = 0, currentWeaponType = 'gun';
const clock = new THREE.Clock();
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playBdaySong() {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const notes = [
        {f:261, d:0.4}, {f:261, d:0.2}, {f:293, d:0.6}, {f:261, d:0.6}, {f:349, d:0.6}, {f:329, d:1.2},
        {f:261, d:0.4}, {f:261, d:0.2}, {f:293, d:0.6}, {f:261, d:0.6}, {f:392, d:0.6}, {f:349, d:1.2}
    ];
    let time = audioCtx.currentTime;
    notes.forEach(n => {
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.connect(g); g.connect(audioCtx.destination);
        osc.frequency.setValueAtTime(n.f, time);
        g.gain.setValueAtTime(0.1, time);
        g.gain.exponentialRampToValueAtTime(0.01, time + n.d);
        osc.start(time); osc.stop(time + n.d);
        time += n.d;
    });
}

function createTexture(type) {
    const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64; const ctx = canvas.getContext('2d');
    const fillNoise = (c) => { ctx.fillStyle = c; ctx.fillRect(0,0,64,64); for(let i=0; i<400; i++) { ctx.fillStyle=`rgba(0,0,0,0.1)`; ctx.fillRect(Math.random()*64,Math.random()*64,4,4); }};
    if(type === 'grass') fillNoise('#5da34b');
    else if (type === 'wood') { ctx.fillStyle='#5c4033'; ctx.fillRect(0,0,64,64); for(let i=0;i<4;i++) { ctx.fillStyle='#4a332a'; ctx.fillRect(i*16,0,4,64); } }
    else if (type === 'face') { fillNoise('#bcaea5'); ctx.fillStyle='#222'; ctx.fillRect(10,20,12,12); ctx.fillRect(42,20,12,12); ctx.fillStyle='#633'; ctx.fillRect(20,45,24,8); }
    const tex = new THREE.CanvasTexture(canvas); tex.magFilter = THREE.NearestFilter; return tex;
}
const textures = { grass: createTexture('grass'), wood: createTexture('wood'), face: createTexture('face') };

function init() {
    scene = new THREE.Scene(); scene.background = new THREE.Color(0x87CEEB);
    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000); camera.rotation.order = 'YXZ';
    renderer = new THREE.WebGLRenderer({ antialias: false }); renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const sun = new THREE.DirectionalLight(0xffffff, 0.8); sun.position.set(50, 100, 50); scene.add(sun);

    const floor = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshLambertMaterial({map: textures.grass}));
    floor.rotation.x = -Math.PI/2; floor.material.map.repeat.set(50, 50); floor.material.map.wrapS = floor.material.map.wrapT = THREE.RepeatWrapping;
    scene.add(floor);

    for(let i=0; i<8; i++) createHouse(Math.random()*160-80, 0, Math.random()*160-80);
    for(let i=0; i<60; i++) createTree(Math.random()*240-120, Math.random()*240-120);

    createBdayClouds();
    createGiftBalloon();
    spawnGuests();
    setupWeapon();

    document.addEventListener('keydown', e => {
        if(e.key === '1') setWeapon('gun'); if(e.key === '2') setWeapon('sword');
        handleKeys(e.code, true);
    });
    document.addEventListener('keyup', e => handleKeys(e.code, false));
    document.addEventListener('mousedown', attack);
    document.addEventListener('mousemove', onMouseMove);
    animate();
}

function createBdayClouds() {
    const cloudMat = new THREE.MeshLambertMaterial({color: 0xffffff, transparent: true, opacity: 0.9});
    const msg = "HAPPY BIRTHDAY MAX";
    msg.split('').forEach((char, i) => {
        if(char === ' ') return;
        const group = new THREE.Group();
        for(let j=0; j<8; j++) {
            const p = new THREE.Mesh(new THREE.SphereGeometry(2, 6, 6), cloudMat);
            p.position.set(Math.random()*3, Math.random()*3, Math.random()*3);
            group.add(p);
        }
        group.position.set(-40 + i*4.5, 50, -80);
        scene.add(group);
    });
}

function createHouse(x, y, z) {
    const grp = new THREE.Group();
    const walls = new THREE.Mesh(new THREE.BoxGeometry(6, 4, 6), new THREE.MeshLambertMaterial({map: textures.wood}));
    walls.position.y = 2; grp.add(walls);
    const roof = new THREE.Mesh(new THREE.ConeGeometry(5.5, 3, 4), new THREE.MeshLambertMaterial({color: 0x5a3a22}));
    roof.position.y = 5.5; roof.rotation.y = Math.PI/4; grp.add(roof);
    grp.position.set(x, y, z); scene.add(grp);
}

function createTree(x, z) {
    const trunk = new THREE.Mesh(new THREE.BoxGeometry(1, 5, 1), new THREE.MeshLambertMaterial({map: textures.wood}));
    trunk.position.set(x, 2.5, z); scene.add(trunk);
    const leaves = new THREE.Mesh(new THREE.BoxGeometry(4, 4, 4), new THREE.MeshLambertMaterial({color: 0x2d5a27}));
    leaves.position.set(x, 6, z); scene.add(leaves);
}

function createGiftBalloon() {
    balloonGift = new THREE.Group();
    const sphere = new THREE.Mesh(new THREE.SphereGeometry(1.5, 16, 16), new THREE.MeshLambertMaterial({color: 0xff4444}));
    const box = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), new THREE.MeshLambertMaterial({color: 0xffff44}));
    const line = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 4), new THREE.MeshBasicMaterial({color: 0xffffff}));
    line.position.y = -2; box.position.y = -4;
    balloonGift.add(sphere, box, line);
    balloonGift.position.set(0, 10, -15);
    balloonGift.userData = { isGift: true };
    scene.add(balloonGift);
}

function spawnGuests() {
    for(let i=0; i<20; i++) {
        const mob = createOriginalMob();
        mob.position.set(Math.random()*140-70, 0, Math.random()*140-70);
        scene.add(mob);
        targets.push(mob);
    }
}

function createOriginalMob() {
    const mob = new THREE.Group();
    const matSkin = new THREE.MeshLambertMaterial({color: 0x5D995D});
    const matClothes = new THREE.MeshLambertMaterial({color: 0x3C50C4});
    const headMats = [matSkin, matSkin, matSkin, matSkin, new THREE.MeshLambertMaterial({map: textures.face}), matSkin];
    const body = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.75, 0.25), matClothes); body.position.y = 1.125;
    const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), headMats); head.position.y = 1.75;
    const armL = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.75, 0.2), matSkin); armL.position.set(-0.35, 1.5, 0);
    const armR = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.75, 0.2), matSkin); armR.position.set(0.35, 1.5, 0);
    const legL = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.75, 0.2), matSkin); legL.position.set(-0.15, 0.375, 0);
    const legR = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.75, 0.2), matSkin); legR.position.set(0.15, 0.375, 0);
    const hat = new THREE.Mesh(new THREE.ConeGeometry(0.2, 0.6, 8), new THREE.MeshLambertMaterial({color: Math.random()*0xffffff}));
    hat.position.y = 2.2;
    mob.add(body, head, armL, armR, legL, legR, hat);
    mob.userData = { armL, armR, legL, legR };
    return mob;
}

function setupWeapon() {
    weaponGroup = new THREE.Group(); scene.add(weaponGroup);
    setWeapon('gun');
}

function setWeapon(type) {
    currentWeaponType = type; weaponGroup.clear();
    const mesh = type === 'gun' ? 
        new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.8), new THREE.MeshLambertMaterial({color: 0x333})) :
        new THREE.Mesh(new THREE.BoxGeometry(0.1, 1.2, 0.2), new THREE.MeshLambertMaterial({color: 0x88ccff}));
    weaponGroup.add(mesh);
    document.getElementById('slot-0').className = type === 'gun' ? 'slot active' : 'slot';
    document.getElementById('slot-1').className = type === 'sword' ? 'slot active' : 'slot';
}

function attack() {
    if(audioCtx.state === 'suspended') { audioCtx.resume(); playBdaySong(); }
    const ray = new THREE.Raycaster();
    ray.setFromCamera(new THREE.Vector2(0,0), camera);
    const hits = ray.intersectObjects(scene.children, true);
    if(hits.length > 0) {
        let obj = hits[0].object;
        while(obj.parent && !obj.userData.isGift) obj = obj.parent;
        if(obj.userData && obj.userData.isGift) {
            scene.remove(obj);
            document.getElementById('bday-card').style.display = 'block';
            document.exitPointerLock();
        }
    }
}

function handleKeys(code, state) {
    if(code === 'KeyW') move.fwd = state; if(code === 'KeyS') move.bwd = state;
    if(code === 'KeyA') move.left = state; if(code === 'KeyD') move.right = state;
    if(code === 'Space') move.jump = state;
}

function onMouseMove(e) {
    if(document.pointerLockElement) {
        yaw -= e.movementX * 0.002; pitch -= e.movementY * 0.002;
        pitch = Math.max(-1.5, Math.min(1.5, pitch));
        camera.rotation.set(pitch, yaw, 0);
    }
}

function animate() {
    requestAnimationFrame(animate);
    const delta = clock.getDelta();
    const time = Date.now() * 0.002;

    const dir = new THREE.Vector3();
    if(move.fwd) dir.z -= 1; if(move.bwd) dir.z += 1;
    if(move.left) dir.x -= 1; if(move.right) dir.x += 1;
    dir.applyQuaternion(camera.quaternion); dir.y = 0;
    camera.position.add(dir.normalize().multiplyScalar(12 * delta));
    if(camera.position.y < 1.7) camera.position.y = 1.7;

    weaponGroup.position.copy(camera.position);
    weaponGroup.quaternion.copy(camera.quaternion);
    weaponGroup.translateX(0.5); weaponGroup.translateY(-0.4); weaponGroup.translateZ(-0.8);

    if(balloonGift) balloonGift.position.y += Math.sin(time)*0.015;

    targets.forEach(mob => {
        const w = Math.sin(time * 6);
        mob.userData.armL.rotation.x = w;
        mob.userData.armR.rotation.x = -w;
        mob.userData.legL.rotation.x = -w;
        mob.userData.legR.rotation.x = w;
    });

    renderer.render(scene, camera);
}

document.body.addEventListener('click', () => { 
    if(document.getElementById('bday-card').style.display !== 'block') document.body.requestPointerLock(); 
});
init();
</script>
</body>
</html>
