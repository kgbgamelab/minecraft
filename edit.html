<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Minecraft BLOB Generator</title>
    <style>
        body { background: #121212; color: #fff; font-family: sans-serif; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        textarea { width: 100%; height: 200px; background: #1e1e1e; color: #0f0; border: 1px solid #555; padding: 10px; font-family: monospace; }
        .btn { width: 100%; padding: 20px; background: #ffaa00; color: #000; font-weight: bold; border: none; cursor: pointer; font-size: 18px; margin-top: 10px; }
        .btn:hover { background: #e69900; }
        #output { display: none; margin-top: 20px; border-top: 2px solid #555; padding-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color: #ffaa00;">ГЕНЕРАТОР ЧЕРЕЗ BLOB (БЕЗ ЛИМИТОВ URL)</h2>
    <p>Вставь задания (строка = вопрос):<br><code>Вопрос | Верный | Неверный | Неверный</code></p>
    <textarea id="qInput" placeholder="2 + 2 = ? | 4 | 5 | 22&#10;Capital of UK? | London | Paris | Berlin&#10;https://i.imgur.com/icon.png | Картинка | Текст | Звук"></textarea>

    <button class="btn" onclick="generate()">Сгенерировать код</button>

    <div id="output">
        <h3>1. Нажми кнопку "Скопировать" ниже:</h3>
        <textarea id="result"></textarea>
        <button class="btn" style="background:#55ff55;" onclick="copyRes()">СКОПИРОВАТЬ ДЛЯ GENIALLY</button>
        <p style="color: #aaa; font-size: 12px;">В Genially: Insert -> Others -> Вставить код -> Insert</p>
    </div>
</div>

<script>
// ИСХОДНИК ИГРЫ (ОПТИМИЗИРОВАННЫЙ ПОД BLOB)
const gameTemplate = (questions) => `<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"><\/script>
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<style>
body{margin:0;overflow:hidden;background:#87CEEB;font-family:'VT323',monospace;user-select:none}
#ui{position:absolute;width:100%;height:100%;pointer-events:none}
#aim{position:absolute;top:50%;left:50%;width:24px;height:24px;transform:translate(-50%,-50%);border:2px solid white;border-radius:50%}
#qbox{position:absolute;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);padding:15px;border:3px solid #fff;color:#fff;text-align:center;min-width:300px}
#qtxt{font-size:32px;color:#ff0;margin-top:10px}
.hp{width:30px;height:30px;background:red;margin:2px;display:inline-block;border:2px solid #000}
.dead{background:#333}
#stats{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);text-align:center}
#win,#die{display:none;position:absolute;inset:0;background:rgba(0,0,0,0.9);flex-direction:column;justify-content:center;align-items:center;color:#fff;z-index:99;pointer-events:auto}
button{font-size:30px;padding:10px 20px;cursor:pointer;background:#ffaa00;border:none;margin-top:20px;font-family:'VT323',monospace}
</style>
</head>
<body>
<div id="die"><h1>YOU DIED</h1><button onclick="location.reload()">RESPAWN</button></div>
<div id="win"><h1>VICTORY!</h1><button onclick="location.reload()">REPLAY</button></div>
<div id="ui">
 <div id="qbox"><div>QUEST</div><div id="qtxt">Loading...</div></div>
 <div id="aim"></div>
 <div id="stats"><div id="hps"></div></div>
</div>
<script>
// ВОПРОСЫ
const qs = ${questions};

let sc,cam,ren,curr=0,hp=5,tgs=[],mv={f:0,b:0,l:0,r:0,j:0,s:0},pl={vy:0,gr:0},dead=0;

function init(){
 sc=new THREE.Scene();sc.background=new THREE.Color(0x87CEEB);
 cam=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.1,500);
 ren=new THREE.WebGLRenderer({antialias:true});ren.setSize(window.innerWidth,window.innerHeight);
 document.body.appendChild(ren.domElement);
 
 const sun=new THREE.DirectionalLight(0xffffff,1);sun.position.set(50,100,50);sc.add(sun,new THREE.AmbientLight(0xffffff,0.6));
 const fl=new THREE.Mesh(new THREE.PlaneGeometry(300,300),new THREE.MeshLambertMaterial({color:0x5da34b}));fl.rotation.x=-Math.PI/2;sc.add(fl);
 
 // Дома
 [[20,20],[-20,-20]].forEach(p=>house(p[0],p[1]));
 
 loadQ();
 updHp();
 
 requestAnimationFrame(loop);
 document.onkeydown=e=>k(e.code,1);document.onkeyup=e=>k(e.code,0);
 document.onmousedown=sht;document.onmousemove=mm;
 document.body.onclick=()=>document.body.requestPointerLock();
 window.onresize=()=>{cam.aspect=window.innerWidth/window.innerHeight;cam.updateProjectionMatrix();ren.setSize(window.innerWidth,window.innerHeight)};
}

function house(x,z){
 const g=new THREE.Group();
 const w=new THREE.Mesh(new THREE.BoxGeometry(8,5,8),new THREE.MeshLambertMaterial({color:0x5c4033}));w.position.y=2.5;
 const r=new THREE.Mesh(new THREE.ConeGeometry(7,4,4),new THREE.MeshLambertMaterial({color:0x4a332a}));r.position.y=6.5;r.rotation.y=Math.PI/4;
 g.add(w,r);g.position.set(x,0,z);sc.add(g);
}

async function mkLbl(txt){
 const c=document.createElement('canvas');c.width=512;c.height=128;const x=c.getContext('2d');
 x.fillStyle='rgba(0,0,0,0.8)';x.fillRect(0,0,512,128);x.strokeStyle='#fff';x.lineWidth=6;x.strokeRect(0,0,512,128);
 if(txt.includes('$')){
  const d=document.createElement('div');katex.render(txt.replace(/\\\\$/g,''),d);
  x.fillStyle='#ff0';x.font='50px Arial';x.textAlign='center';x.textBaseline='middle';x.fillText(d.innerText,256,64);
 } else if(txt.startsWith('http')){
  const i=new Image();i.crossOrigin="anonymous";i.src=txt;await new Promise(r=>i.onload=r);x.drawImage(i,200,10,112,108);
 } else {
  x.fillStyle='#fff';x.font='bold 50px monospace';x.textAlign='center';x.textBaseline='middle';x.fillText(txt,256,64);
 }
 return new THREE.CanvasTexture(c);
}

async function loadQ(){
 if(curr>=qs.length){document.exitPointerLock();document.getElementById('win').style.display='flex';return;}
 tgs.forEach(t=>sc.remove(t.o));tgs=[];
 
 const q=qs[curr];
 const el=document.getElementById('qtxt');
 if(q.q.startsWith('http'))el.innerHTML='<img src="'+q.q+'" height="80">';
 else if(q.q.includes('$'))katex.render(q.q.replace(/\\\\$/g,''),el);
 else el.innerText=q.q;

 const ans=q.a.map((t,i)=>({t,ok:i===0})).sort(()=>Math.random()-.5);
 
 for(let i=0;i<ans.length;i++){
  const g=new THREE.Group();
  // Тело
  const b=new THREE.Mesh(new THREE.BoxGeometry(1.2,2.5,1.2),new THREE.MeshLambertMaterial({color:0x3C50C4}));b.position.y=1.25;
  // Табличка
  const tx=await mkLbl(ans[i].t);
  const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:tx}));sp.position.y=4;sp.scale.set(4,1,1);
  
  g.add(b,sp);
  // СПАВН ВОКРУГ ИГРОКА (Радиус 15)
  const a=(i/ans.length)*6.28 + (Math.random()*0.5);
  g.position.set(Math.cos(a)*15, 0, Math.sin(a)*15); 
  
  g.userData={ok:ans[i].ok};
  sc.add(g);tgs.push({o:g});
 }
}

function sht(){
 if(!document.pointerLockElement||dead)return;
 const r=new THREE.Raycaster();r.setFromCamera({x:0,y:0},cam);
 const h=r.intersectObjects(sc.children,true);
 if(h.length){
  let o=h[0].object;while(o.parent&&o.parent!==sc)o=o.parent;
  if(o.userData.ok!==undefined){
   if(o.userData.ok){curr++;loadQ();}
   else{hp--;updHp();if(hp<=0){dead=1;document.exitPointerLock();document.getElementById('die').style.display='flex';}}
  }
 }
}

function updHp(){let h='';for(let i=0;i<5;i++)h+='<div class="hp '+(i>=hp?'dead':'')+'"></div>';document.getElementById('hps').innerHTML=h;}
function k(c,v){if(c=='KeyW')mv.f=v;if(c=='KeyS')mv.b=v;if(c=='KeyA')mv.l=v;if(c=='KeyD')mv.r=v;if(c=='Space')mv.j=v;if(c=='ShiftLeft')mv.s=v;}
function mm(e){if(document.pointerLockElement&&!dead){cam.rotation.y-=e.movementX*0.002;cam.rotation.x-=e.movementY*0.002;cam.rotation.x=Math.max(-1.5,Math.min(1.5,cam.rotation.x));}}

function loop(){
 if(!dead){
  const s=mv.s?0.3:0.15,d=new THREE.Vector3();cam.getWorldDirection(d);d.y=0;d.normalize();
  const r=new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0),d).normalize();
  if(mv.f)cam.position.addScaledVector(d,s);if(mv.b)cam.position.addScaledVector(d,-s);
  if(mv.l)cam.position.addScaledVector(r,s);if(mv.r)cam.position.addScaledVector(r,-s);
  
  if(pl.gr&&mv.j){pl.vy=0.4;pl.gr=0;}
  pl.vy-=0.02;cam.position.y+=pl.vy;
  if(cam.position.y<1.7){cam.position.y=1.7;pl.vy=0;pl.gr=1;}
  
  tgs.forEach(t=>t.o.lookAt(cam.position.x,0,cam.position.z));
 }
 ren.render(sc,cam);requestAnimationFrame(loop);
}
init();
<\/script>
</body>
</html>`;

function generate() {
    const raw = document.getElementById('qInput').value.trim();
    if(!raw) return alert("Введите хотя бы одно задание!");

    // Парсим вопросы в JSON
    const questions = raw.split('\n').map(l => {
        const p = l.split('|').map(s=>s.trim());
        return {q: p[0], a: [p[1], p[2], p[3]], c: 0};
    });

    // Вставляем JSON в шаблон игры (БЕЗ URL ENCODING!)
    // Обратные кавычки экранируем, чтобы шаблон не сломался
    const finalHTML = gameTemplate(JSON.stringify(questions))
        .replace(/`/g, '\\`')
        .replace(/\$/g, '\\$');

    // СОЗДАЕМ СКРИПТ, КОТОРЫЙ ПРЕВРАТИТ ЭТОТ HTML В BLOB
    const blobLoader = `<div id="game-root" style="width:100%; height:100%; background:#000;"></div>
<script>
(function() {
    // Весь код игры хранится как простая строка
    var gameSource = \`${finalHTML}\`;

    // Создаем Blob (виртуальный файл в памяти)
    var blob = new Blob([gameSource], {type: 'text/html'});
    var url = URL.createObjectURL(blob);

    // Вставляем Iframe с ссылкой на Blob
    var container = document.getElementById('game-root');
    var iframe = document.createElement('iframe');
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.style.border = "none";
    iframe.allow = "autoplay; fullscreen; pointer-lock;";
    iframe.src = url;
    
    container.appendChild(iframe);
})();
<\/script>`;

    document.getElementById('result').value = blobLoader;
    document.getElementById('output').style.display = 'block';
}

function copyRes() {
    document.getElementById('result').select();
    document.execCommand('copy');
    alert("Код скопирован! Вставляй в Genially.");
}
</script>
</body>
</html>
