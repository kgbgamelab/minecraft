<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Minecraft Editor V3.0 (Blob Edition)</title>
    <style>
        body { background: #1a1a1a; color: #eee; font-family: sans-serif; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        textarea.input-q { width: 100%; height: 200px; background: #222; color: #0f0; border: 1px solid #444; padding: 10px; font-family: monospace; }
        textarea.output { width: 100%; height: 150px; background: #333; color: #fff; padding: 10px; border: none; margin-top: 10px; }
        button { background: #ffaa00; color: #000; padding: 15px 30px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 20px; width: 100%; }
        button:hover { background: #e69900; }
        .hidden-engine { display: none; }
        h2 { border-bottom: 2px solid #ffaa00; padding-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üõ† –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä V3.0 (–ë–µ–∑ –æ—à–∏–±–æ–∫ —Å –∫–∞–≤—ã—á–∫–∞–º–∏)</h2>
    <p>–í—Å—Ç–∞–≤—å –∑–∞–¥–∞–Ω–∏—è (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ = –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å):<br>
    <i>–í–æ–ø—Ä–æ—Å | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π | –ù–µ–≤–µ—Ä–Ω—ã–π</i></p>
    
    <textarea class="input-q" id="userQuestions" placeholder="2 + 2 = ? | 4 | 5 | 22
–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏? | –ü–∞—Ä–∏–∂ | –†–∏–º | –ë–µ—Ä–ª–∏–Ω
https://i.imgur.com/example.png | –ö–∞—Ä—Ç–∏–Ω–∫–∞ | –¢–µ–∫—Å—Ç | –ó–≤—É–∫"></textarea>

    <button onclick="generateSafeCode()">–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ –ö–û–î</button>

    <div id="resultBlock" style="display:none; margin-top: 30px;">
        <h3>‚úÖ –ì–æ—Ç–æ–≤—ã–π –∫–æ–¥ –¥–ª—è Genially:</h3>
        <p style="font-size: 12px; color: #aaa;">–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —Å–∫–æ–ø–∏—Ä—É–π –≤—Å—ë –∏ –≤—Å—Ç–∞–≤—å –≤ Insert -> Others</p>
        <textarea class="output" id="finalCode"></textarea>
        <button onclick="copyCode()" style="background: #55ff55;">–ö–û–ü–ò–†–û–í–ê–¢–¨</button>
    </div>
</div>

<textarea id="gameEngineSource" class="hidden-engine">
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Minecraft Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'VT323', monospace; user-select: none; }
        #hud { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        #loading { position: absolute; top:0; left:0; width:100%; height:100%; background:#000; display:flex; justify-content:center; align-items:center; color:#fff; font-size:40px; z-index:9999; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; transform: translate(-50%, -50%); mix-blend-mode: difference; }
        #crosshair::before, #crosshair::after { content: ''; position: absolute; background: white; }
        #crosshair::before { top: 9px; left: 0; width: 20px; height: 2px; }
        #crosshair::after { top: 0; left: 9px; width: 2px; height: 20px; }
        #q-box { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 10px 30px; border: 3px solid #fff; color: #fff; text-align: center; min-width: 300px; }
        #q-text { font-size: 32px; color: #ffff55; margin-top: 5px; }
        #game-over, #win-screen { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.9); flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 1000; pointer-events: auto; }
        .btn { font-size: 30px; color: #ffff55; cursor: pointer; text-decoration: underline; margin-top: 20px; }
        .hearts { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; }
        .heart { width: 30px; height: 30px; background: red; clip-path: polygon(50% 0%, 100% 35%, 82% 100%, 50% 75%, 18% 100%, 0% 35%); }
        .heart.lost { background: #555; }
    </style>
</head>
<body>
    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∏—Ä–∞...</div>
    <div id="hud">
        <div id="q-box"><div>–ó–ê–î–ê–ù–ò–ï</div><div id="q-text">...</div></div>
        <div id="crosshair"></div>
        <div class="hearts" id="hearts-container"><div class="heart"></div><div class="heart"></div><div class="heart"></div><div class="heart"></div><div class="heart"></div></div>
    </div>
    <div id="game-over"><h1>–í–´ –ü–û–ì–ò–ë–õ–ò</h1><div class="btn" onclick="location.reload()">–í–æ–∑—Ä–æ–¥–∏—Ç—å—Å—è</div></div>
    <div id="win-screen"><h1 style="color:#55ff55">–ü–û–ë–ï–î–ê!</h1><div class="btn" onclick="location.reload()">–ó–∞–Ω–æ–≤–æ</div></div>

    <script>
        // –í –≠–¢–£ –ü–ï–†–ï–ú–ï–ù–ù–£–Æ –í–°–¢–ê–í–Ø–¢–°–Ø –í–û–ü–†–û–°–´ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò
        var questions = {{QUESTIONS_PLACEHOLDER}};
        
        var scene, camera, renderer, currentQ = 0, health = 5;
        var targets = [], move = {f:0, b:0, l:0, r:0, s:0, j:0}, player = {velY:0, onGround:false};
        
        function init() {
            scene = new THREE.Scene(); scene.background = new THREE.Color(0x87CEEB); scene.fog = new THREE.Fog(0x87CEEB, 20, 60);
            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({antialias:true}); renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            
            // –°–≤–µ—Ç
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const sun = new THREE.DirectionalLight(0xffffff, 0.8); sun.position.set(50,100,50); scene.add(sun);
            
            // –ü–æ–ª
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(200,200), new THREE.MeshLambertMaterial({color:0x5da34b}));
            floor.rotation.x = -Math.PI/2; scene.add(floor);
            
            // –î–æ–º–∏–∫–∏ (–¥–µ–∫–æ—Ä)
            createHouse(-20, -20); createHouse(20, 10);
            
            loadQuestion();
            document.getElementById('loading').style.display = 'none';
            animate();
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            document.onkeydown = e => key(e.code, 1);
            document.onkeyup = e => key(e.code, 0);
            document.onmousedown = attack;
            document.onmousemove = e => { if(document.pointerLockElement) { camera.rotation.y-=e.movementX*0.002; camera.rotation.x-=e.movementY*0.002; camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x)); }};
            document.body.onclick = () => document.body.requestPointerLock();
            window.onresize = () => { camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); };
        }
        
        function createHouse(x, z) {
            const h = new THREE.Group();
            const w = new THREE.Mesh(new THREE.BoxGeometry(6,4,6), new THREE.MeshLambertMaterial({color:0x5c4033})); w.position.y=2;
            const r = new THREE.Mesh(new THREE.ConeGeometry(5,3,4), new THREE.MeshLambertMaterial({color:0x4a332a})); r.position.y=5.5; r.rotation.y=Math.PI/4;
            h.add(w,r); h.position.set(x,0,z); scene.add(h);
        }

        async function createLabel(text) {
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.fillRect(0,0,512,128);
            ctx.strokeStyle = '#fff'; ctx.lineWidth=6; ctx.strokeRect(0,0,512,128);
            
            if(text.includes('$')) {
                const d = document.createElement('div'); katex.render(text.replace(/\\$/g,''), d);
                ctx.fillStyle = 'yellow'; ctx.font = '50px Arial'; ctx.textAlign = 'center'; ctx.textBaseline='middle';
                ctx.fillText(d.innerText, 256, 64);
            } else if(text.startsWith('http')) {
                const img = new Image(); img.crossOrigin="anonymous"; img.src=text;
                await new Promise(r => img.onload=r); ctx.drawImage(img, 192, 14, 128, 100);
            } else {
                ctx.fillStyle = 'white'; ctx.font = 'bold 50px VT323'; ctx.textAlign = 'center'; ctx.textBaseline='middle';
                ctx.fillText(text, 256, 64);
            }
            return new THREE.CanvasTexture(canvas);
        }

        async function loadQuestion() {
            if(currentQ >= questions.length) { document.exitPointerLock(); document.getElementById('win-screen').style.display='flex'; return; }
            targets.forEach(t => scene.remove(t.obj)); targets = [];
            
            const q = questions[currentQ];
            const qEl = document.getElementById('q-text');
            if(q.q.startsWith('http')) qEl.innerHTML = `<img src="${q.q}" style="height:60px">`;
            else if(q.q.includes('$')) katex.render(q.q.replace(/\\$/g,''), qEl);
            else qEl.innerText = q.q;

            const ans = q.a.map((t,i)=>({t, ok:i===0})).sort(()=>Math.random()-0.5);
            for(let i=0; i<ans.length; i++) {
                const mob = new THREE.Group();
                const body = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshLambertMaterial({color:0x3C50C4})); body.position.y=1;
                const head = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshLambertMaterial({color:0x5D995D})); head.position.y=2.25;
                const tex = await createLabel(ans[i].t);
                const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map:tex})); sprite.position.y=3.5; sprite.scale.set(4,1,1);
                mob.add(body, head, sprite);
                const ang = (i/ans.length)*Math.PI*2;
                mob.position.set(Math.cos(ang)*15, 0, Math.sin(ang)*15);
                mob.userData = {ok: ans[i].ok};
                scene.add(mob); targets.push({obj:mob});
            }
        }

        function attack() {
            if(!document.pointerLockElement) return;
            const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = ray.intersectObjects(scene.children, true);
            if(hits.length>0) {
                let p = hits[0].object; while(p.parent && p.parent!==scene) p=p.parent;
                if(p.userData.ok !== undefined) {
                    if(p.userData.ok) { currentQ++; loadQuestion(); }
                    else { health--; updateHearts(); if(health<=0) {document.exitPointerLock(); document.getElementById('game-over').style.display='flex';} }
                }
            }
        }
        
        function updateHearts() {
            const h = document.querySelectorAll('.heart');
            h.forEach((el,i) => { if(i >= health) el.classList.add('lost'); });
        }

        function key(k, v) {
            if(k=='KeyW') move.f=v; if(k=='KeyS') move.b=v; if(k=='KeyA') move.l=v; if(k=='KeyD') move.r=v;
            if(k=='Space') move.j=v; if(k=='ShiftLeft') move.s=v;
        }

        function animate() {
            requestAnimationFrame(animate);
            const spd = move.s ? 0.3 : 0.15;
            const dir = new THREE.Vector3(); camera.getWorldDirection(dir); dir.y=0; dir.normalize();
            const side = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), dir).normalize();
            if(move.f) camera.position.addScaledVector(dir, spd);
            if(move.b) camera.position.addScaledVector(dir, -spd);
            if(move.l) camera.position.addScaledVector(side, spd);
            if(move.r) camera.position.addScaledVector(side, -spd);
            
            if(player.onGround && move.j) { player.velY = 0.5; player.onGround = false; }
            player.velY -= 0.02; camera.position.y += player.velY;
            if(camera.position.y < 1.7) { camera.position.y = 1.7; player.velY=0; player.onGround=true; }
            
            targets.forEach(t => t.obj.lookAt(camera.position.x, 0, camera.position.z));
            renderer.render(scene, camera);
        }
        init();
    </script>
</body>
</html>
</textarea>

<script>
function generateSafeCode() {
    // 1. –ë–µ—Ä–µ–º –≤–æ–ø—Ä–æ—Å—ã
    const rawQ = document.getElementById('userQuestions').value.trim();
    if(!rawQ) return alert("–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å!");
    
    const questions = rawQ.split('\n').map(line => {
        const p = line.split('|').map(s => s.trim());
        return { q: p[0], a: [p[1], p[2], p[3]] };
    });

    // 2. –ë–µ—Ä–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –¥–≤–∏–∂–∫–∞ (–∫–∞–∫ —Ç–µ–∫—Å—Ç)
    let engine = document.getElementById('gameEngineSource').value;
    
    // 3. –í—Å—Ç–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å—ã –≤ –¥–≤–∏–∂–æ–∫ (–ø—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ —Ç–µ–∫—Å—Ç–∞)
    engine = engine.replace('{{QUESTIONS_PLACEHOLDER}}', JSON.stringify(questions));

    // 4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º "–ó–∞–≥—Ä—É–∑—á–∏–∫" –¥–ª—è Genially
    // –ú—ã –Ω–µ –≤—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–¥ –≤ src. –ú—ã —Å–æ–∑–¥–∞–µ–º Blob (–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª).
    
    const loaderCode = `<div id="game-root" style="width:100%; height:100%; background:#000; color:white; display:flex; justify-content:center; align-items:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<script>
(function() {
    var gameHTML = \`${engine.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`;
    
    var blob = new Blob([gameHTML], {type: 'text/html'});
    var url = URL.createObjectURL(blob);
    
    var container = document.getElementById('game-root');
    container.innerHTML = ''; // –æ—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç "–ó–∞–≥—Ä—É–∑–∫–∞"
    
    var iframe = document.createElement('iframe');
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.style.border = "none";
    iframe.allow = "autoplay; fullscreen; pointer-lock;";
    iframe.src = url;
    
    container.appendChild(iframe);
})();
<\/script>`;

    document.getElementById('finalCode').value = loaderCode;
    document.getElementById('resultBlock').style.display = 'block';
}

function copyCode() {
    document.getElementById('finalCode').select();
    document.execCommand('copy');
    alert("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –¢–µ–ø–µ—Ä—å –≤—Å—Ç–∞–≤—å –µ–≥–æ –≤ Genially.");
}
</script>

</body>
</html>
