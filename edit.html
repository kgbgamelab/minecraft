<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Minecraft Genially Editor (GitHub Version)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --green: #55ff55; --blue: #87CEEB; --text: #e0e0e0; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { background: #000; padding: 15px 20px; border-bottom: 2px solid var(--green); display: flex; justify-content: space-between; align-items: center; }
        .logo-area { display: flex; align-items: center; gap: 15px; }
        .logo-img { height: 45px; }
        h1 { font-family: 'VT323', monospace; color: var(--green); margin: 0; font-size: 28px; letter-spacing: 2px; text-shadow: 2px 2px 0 #006400; }
        
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* –°–∞–π–¥–±–∞—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        .sidebar { width: 400px; background: var(--panel); border-right: 1px solid #333; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        
        /* –û–±–ª–∞—Å—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        .preview-area { flex: 1; background: #000; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #preview-frame { width: 100%; max-width: 1200px; aspect-ratio: 16/9; border: 4px solid var(--green); background: #87CEEB; box-shadow: 0 0 20px rgba(85,255,85,0.2); }
        
        /* –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        label { color: #aaa; font-size: 0.9rem; display: block; margin-bottom: 5px; }
        input, select { width: 100%; background: #2d2d2d; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 4px; box-sizing: border-box; font-family: 'VT323', monospace; font-size: 1.2rem; }
        input:focus { border-color: var(--green); outline: none; }
        
        .q-card { background: #252525; padding: 15px; border-radius: 6px; border: 1px solid #444; position: relative; }
        .q-card:hover { border-color: #666; }
        .btn-del { position: absolute; top: 10px; right: 10px; background: #ff5555; border: none; color: white; cursor: pointer; font-weight: bold; border-radius: 3px; padding: 2px 8px; }
        
        .ans-row { display: flex; gap: 10px; align-items: center; margin-top: 8px; }
        .ans-row input[type="radio"] { width: auto; accent-color: var(--green); transform: scale(1.5); }
        
        .btn { background: var(--green); color: #000; border: none; padding: 10px 25px; font-family: 'VT323', monospace; font-size: 1.5rem; cursor: pointer; text-transform: uppercase; font-weight: bold; border-radius: 4px; transition: 0.2s; box-shadow: 0 4px 0 #004d00; }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-add { background: #333; color: var(--blue); width: 100%; border: 2px dashed #444; margin-top: 10px; box-shadow: none; }
        .btn-add:hover { background: #444; border-color: var(--blue); }
        .btn-update { position: absolute; top: 20px; right: 20px; font-size: 1.2rem; z-index: 100; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–¥–∞ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; flex-direction: column; padding: 20px; }
        .code-box { width: 80%; height: 50%; background: #111; color: var(--green); border: 2px solid #555; font-family: monospace; padding: 15px; margin-bottom: 20px; resize: none; font-size: 14px; }
        
        footer { background: #000; padding: 10px; text-align: center; font-family: 'VT323'; color: #666; font-size: 1.1rem; border-top: 1px solid #333; }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <img src="https://con.xl.ru/fnfLZuvpAUiDaqDs8d1-2g/images/kcJYv7OsYUSGt5AfGq5jIw.png" alt="Logo" class="logo-img">
        <div>
            <h1>MINECRAFT GENIALLY BUILDER</h1>
            <span style="font-size:12px; color:#888; font-family:sans-serif;">–ü–û–î–î–ï–†–ñ–ö–ê: –ö–ê–†–¢–ò–ù–ö–ò (URL), TEKCT, LATEX ($...$)</span>
        </div>
    </div>
    <button class="btn" onclick="generateFinalCode()">–ì–û–¢–û–í–û (–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥)</button>
</header>

<div class="main-container">
    <div class="sidebar">
        <div>
            <label>–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏–≥—Ä—ã</label>
            <select id="lang">
                <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                <option value="en">English</option>
                <option value="de">Deutsch</option>
                <option value="fr">Fran√ßais</option>
                <option value="es">Espa√±ol</option>
                <option value="ja">Êó•Êú¨Ë™û</option>
                <option value="zh">‰∏≠Êñá</option>
            </select>
        </div>

        <div id="q-container" style="display:flex; flex-direction:column; gap:15px;"></div>
        
        <button class="btn btn-add" onclick="addQuestion()">+ –î–û–ë–ê–í–ò–¢–¨ –í–û–ü–†–û–°</button>
    </div>

    <div class="preview-area">
        <button class="btn btn-update" onclick="updatePreview()">üîÑ –û–ë–ù–û–í–ò–¢–¨ –ü–†–ï–î–ü–†–û–°–ú–û–¢–†</button>
        <iframe id="preview-frame"></iframe>
    </div>
</div>

<footer>(c) –ö–æ—Ä–ø–æ—Ä–∞—Ü–∏—è –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ë—É–¥—É—â–µ–≥–æ 2026</footer>

<div id="modal" class="modal">
    <h2 style="font-family:'VT323'; color:white; font-size: 40px; margin-bottom: 10px;">–ö–û–î –î–õ–Ø –í–°–¢–ê–í–ö–ò –í GENIALLY</h2>
    <p style="color: #aaa; margin-bottom: 10px;">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ Insert -> Others (Iframe —É–∂–µ –≤—Å—Ç—Ä–æ–µ–Ω!)</p>
    <textarea id="final-code" class="code-box" readonly onclick="this.select()"></textarea>
    <button class="btn" onclick="document.getElementById('modal').style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
</div>

<script>
    // --- –î–ê–ù–ù–´–ï –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ ---
    const defaultQ = { q: "–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2 + 2?", a: ["$3$", "$4$", "$5$"], c: 1 };
    let questions = [JSON.parse(JSON.stringify(defaultQ))];

    // --- –†–ï–ù–î–ï–†–ò–ù–ì –†–ï–î–ê–ö–¢–û–†–ê ---
    function renderQuestions() {
        const c = document.getElementById("q-container");
        c.innerHTML = "";
        questions.forEach((item, i) => {
            let answersHTML = "";
            item.a.forEach((ans, ai) => {
                answersHTML += `<div class="ans-row">
                    <input type="radio" name="g${i}" ${item.c === ai ? "checked" : ""} onchange="updateQ(${i}, 'c', ${ai})">
                    <input type="text" value="${ans.replace(/"/g, "&quot;")}" oninput="updateQ(${i}, 'a', ${ai}, this.value)" placeholder="–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ (–∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É)">
                </div>`;
            });

            c.innerHTML += `<div class="q-card">
                <button class="btn-del" onclick="delQ(${i})">–£–¥–∞–ª–∏—Ç—å</button>
                <label style="color:var(--green)">–í–æ–ø—Ä–æ—Å ${i+1}</label>
                <input type="text" value="${item.q.replace(/"/g, "&quot;")}" oninput="updateQ(${i}, 'q', null, this.value)" placeholder="–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞, —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ $LaTeX$">
                <label style="margin-top:10px">–í–∞—Ä–∏–∞–Ω—Ç—ã (–ú–æ–±—ã):</label>
                ${answersHTML}
            </div>`;
        });
    }

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–ú–ò ---
    function addQuestion() { questions.push(JSON.parse(JSON.stringify(defaultQ))); renderQuestions(); }
    function delQ(i) { if(questions.length > 1) { questions.splice(i,1); renderQuestions(); } else { alert("–ù—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å!"); } }
    function updateQ(idx, type, subIdx, val) {
        if(type === 'q') questions[idx].q = val;
        if(type === 'c') questions[idx].c = subIdx;
        if(type === 'a') questions[idx].a[subIdx] = val;
    }

    // --- –ì–ï–ù–ï–†–ê–¢–û–† –®–ê–ë–õ–û–ù–ê –ò–ì–†–´ ---
    function getGameHTML() {
        const lang = document.getElementById("lang").value;
        const configStr = JSON.stringify({ lang, questions });
        
        // –í–ê–ñ–ù–û: –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä
        return `<!DOCTYPE html>
<html lang="${lang}">
<head>
<meta charset="UTF-8">
<title>MC Game</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"><\/script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<style>
body{margin:0;overflow:hidden;background:#87CEEB;font-family:'VT323',monospace;user-select:none}
#hud{position:absolute;width:100%;height:100%;pointer-events:none}
.float-text{position:absolute;color:#ffff55;font-size:40px;font-weight:bold;text-shadow:3px 3px 0 #000;pointer-events:none;animation:floatUp 1s forwards}
@keyframes floatUp{to{transform:translateY(-120px) scale(1.2);opacity:0}}
#crosshair{position:absolute;top:50%;left:50%;width:24px;height:24px;transform:translate(-50%,-50%);mix-blend-mode:difference}
#crosshair::before{content:'';position:absolute;top:11px;left:0;width:24px;height:2px;background:white}
#crosshair::after{content:'';position:absolute;top:0;left:11px;width:2px;height:24px;background:white}
#bottom-ui{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);width:600px;text-align:center}
.hearts{display:flex;gap:4px;justify-content:center;margin-bottom:5px}
.heart{width:32px;height:32px;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10"><path fill="%23ff0000" stroke="black" stroke-width="0.5" d="M2 1h2v1h2V1h2v2H7v1H6v1H5v1H4V5H3V4H2V2h2z"/></svg>');background-size:contain;image-rendering:pixelated}
.heart.lost{filter:grayscale(100%) brightness(0.3)}
#xp-bar{width:100%;height:16px;background:#222;border:3px solid #000;position:relative;margin-bottom:10px}
#xp-fill{height:100%;background:linear-gradient(to right,#00ff00,#55ff55);width:0%;transition:width 0.2s}
#xp-info{position:absolute;top:-35px;width:100%;color:#80ff00;font-size:30px;text-shadow:2px 2px 0 #000;display:flex;justify-content:space-around}
#hotbar{display:flex;justify-content:center;gap:4px;background:rgba(0,0,0,0.6);padding:5px;border:2px solid #fff;border-radius:4px}
.slot{width:60px;height:60px;background:#8b8b8b;border:4px solid #373737;border-top-color:#ddd;border-left-color:#ddd;display:flex;align-items:center;justify-content:center;font-size:30px;color:white}
.slot.active{border-color:white;background:#a0a0a0;transform:scale(1.1)}
#quest-box{position:absolute;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:15px 40px;border:3px solid #fff;color:white;text-align:center;min-width: 300px;}
#q-text{font-size:32px;color:#ffff55;text-shadow:2px 2px 0 #333}
#q-img{max-height:100px;margin-top:10px;display:none;border:2px solid #fff}
#house-status{position:absolute;top:100px;width:100%;text-align:center;font-size:30px;color:#55ff55;text-shadow:2px 2px 0 #000;display:none}
#damage-overlay,#fire-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:0;transition:opacity 0.2s}
#damage-overlay{background:red}
#fire-overlay{background:linear-gradient(transparent,rgba(255,100,0,0.5));top:auto;bottom:0;height:40%}
#game-over,#win-screen{display:none;position:absolute;top:0;left:0;width:100%;height:100%;flex-direction:column;align-items:center;justify-content:center;color:white;z-index:999;background:rgba(0,0,0,0.9)}
.btn-respawn{font-size:40px;cursor:pointer;color:#ffff55;text-decoration:underline;margin-top:20px}
</style>
</head>
<body>
<div id="damage-overlay"></div><div id="fire-overlay"></div>
<div id="hud">
    <div id="quest-box">
        <div id="lbl-q" style="color:#aaa;font-size:18px;letter-spacing:2px">QUESTION</div>
        <div id="q-text">...</div>
        <img id="q-img" src="">
    </div>
    <div id="house-status"></div>
    <div id="crosshair"></div>
    <div id="bottom-ui">
        <div id="xp-info"><span>XP: <span id="lvl-num">0</span></span><span style="color:#ffd700">COMBO: x<span id="combo-num">0</span></span></div>
        <div class="hearts" id="hearts-container"><div class="heart"></div><div class="heart"></div><div class="heart"></div><div class="heart"></div><div class="heart"></div></div>
        <div id="xp-bar"><div id="xp-fill"></div></div>
        <div id="hotbar"><div class="slot active" id="slot-0">üî´</div><div class="slot" id="slot-1"></div></div>
    </div>
</div>
<div id="game-over"><h1 style="font-size:100px;margin:0;color:#ff5555">YOU DIED</h1><p class="btn-respawn" onclick="location.reload()">Respawn</p></div>
<div id="win-screen"><h1 style="font-size:80px;margin:0;color:#55ff55">QUEST COMPLETE!</h1><div id="win-stats" style="font-size:35px;text-align:center;margin:20px"></div><p class="btn-respawn" onclick="location.reload()">Play Again</p></div>

<script>
const config = ${configStr};
const tr = {
    ru:{q:"–¢–ï–ö–£–©–ò–ô –í–û–ü–†–û–°",safe:"üõ°Ô∏è –í –£–ö–†–´–¢–ò–ò",done:"–í—ã –ø—Ä–æ—à–ª–∏!"},
    en:{q:"CURRENT QUESTION",safe:"üõ°Ô∏è SAFE ZONE",done:"Well done!"},
    de:{q:"AKTUELLE FRAGE",safe:"üõ°Ô∏è SICHERHEIT",done:"Gut gemacht!"},
    fr:{q:"QUESTION ACTUELLE",safe:"üõ°Ô∏è ZONE S√õRE",done:"Bien jou√©!"},
    es:{q:"PREGUNTA ACTUAL",safe:"üõ°Ô∏è ZONA SEGURA",done:"¬°Bien hecho!"},
    ja:{q:"ÁèæÂú®„ÅÆË≥™Âïè",safe:"üõ°Ô∏è ÂÆâÂÖ®Âú∞Â∏Ø",done:"„Çà„Åè„Åß„Åç„Åæ„Åó„Åü"},
    zh:{q:"ÂΩìÂâçÈóÆÈ¢ò",safe:"üõ°Ô∏è ÂÆâÂÖ®Âå∫",done:"ÂÅöÂæóÂ•Ω"}
};
const t = tr[config.lang] || tr.en;
document.getElementById("lbl-q").innerText = t.q;
document.getElementById("house-status").innerText = t.safe;

let scene,camera,renderer,weaponGroup,flash,score=0,currentQ=0,health=5,combo=0;
let targets=[],particles=[],bonuses=[],items=[],projectiles=[],houses=[];
let move={fwd:false,bwd:false,left:false,right:false,sprint:false,jump:false};
let player={vel:new THREE.Vector3(),onGround:false,speed:0};
let pitch=0,yaw=0,isDead=false,isWin=false,isSwinging=false,swingProgress=0;
let currentWeaponType="gun",inventory=["gun"];
const clock=new THREE.Clock();
const audioCtx=new(window.AudioContext||window.webkitAudioContext)();

function renderText(el, text) {
    if(text.includes("$")) {
        try {
            katex.render(text.replace(/\\$/g, ""), el, {throwOnError:false});
        } catch(e) { el.innerText = text; }
    } else { el.innerText = text; }
}

function playSound(type){
    if(audioCtx.state==="suspended")audioCtx.resume();
    const t=audioCtx.currentTime;
    const g=audioCtx.createGain();g.connect(audioCtx.destination);
    const osc=audioCtx.createOscillator();osc.connect(g);
    if(type==="shoot"){osc.type="sawtooth";osc.frequency.setValueAtTime(1200,t);osc.frequency.exponentialRampToValueAtTime(100,t+0.15);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.15);osc.start();osc.stop(t+0.15)}
    else if(type==="hit"){osc.type="sawtooth";osc.frequency.setValueAtTime(100,t);g.gain.setValueAtTime(0.5,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);osc.start();osc.stop(t+0.2)}
    else if(type==="loot"){osc.type="sine";osc.frequency.setValueAtTime(1200,t);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);osc.start();osc.stop(t+0.5)}
}

function createTexture(c1,c2){
    const canvas=document.createElement("canvas");canvas.width=64;canvas.height=64;const ctx=canvas.getContext("2d");
    ctx.fillStyle=c1;ctx.fillRect(0,0,64,64);
    for(let i=0;i<200;i++){ctx.fillStyle="rgba(0,0,0,0.1)";ctx.fillRect(Math.random()*64,Math.random()*64,4,4)}
    if(c2){ctx.fillStyle=c2;ctx.fillRect(10,10,44,44)}
    const tex=new THREE.CanvasTexture(canvas);tex.magFilter=THREE.NearestFilter;return tex;
}
const textures={grass:createTexture("#5da34b"),wood:createTexture("#5c4033"),leaves:createTexture("#2d5a27"),face:createTexture("#bcaea5","#222"),chest:createTexture("#6d4e34","#FFD700")};

function init(){
    scene=new THREE.Scene();scene.background=new THREE.Color(0x87CEEB);scene.fog=new THREE.Fog(0x87CEEB,20,80);
    camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.1,1000);camera.rotation.order="YXZ";
    weaponGroup=new THREE.Group();scene.add(weaponGroup);
    renderer=new THREE.WebGLRenderer({antialias:false});renderer.setSize(window.innerWidth,window.innerHeight);
    renderer.shadowMap.enabled=true;document.body.appendChild(renderer.domElement);
    const amb=new THREE.AmbientLight(0xffffff,0.5);scene.add(amb);
    const sun=new THREE.DirectionalLight(0xffffff,0.8);sun.position.set(50,100,50);sun.castShadow=true;scene.add(sun);
    const floor=new THREE.Mesh(new THREE.PlaneGeometry(300,300),new THREE.MeshLambertMaterial({map:textures.grass}));
    floor.rotation.x=-Math.PI/2;floor.receiveShadow=true;scene.add(floor);
    [20,-30,40].forEach(x=>createHouse(x,0,x));
    setWeapon("gun");spawnLoot();loadQuestion();
    document.addEventListener("keydown",e=>{if(e.key==="1")setWeapon("gun");if(e.key==="2"&&inventory.includes("sword"))setWeapon("sword");if(e.code==="Space")move.jump=true;if(e.code==="ShiftLeft")move.sprint=true;handleKeys(e.code,true)});
    document.addEventListener("keyup",e=>{if(e.code==="Space")move.jump=false;if(e.code==="ShiftLeft")move.sprint=false;handleKeys(e.code,false)});
    document.addEventListener("mousedown",attack);
    document.addEventListener("mousemove",e=>{if(document.pointerLockElement&&!isDead&&!isWin){yaw-=e.movementX*0.002;pitch-=e.movementY*0.002;pitch=Math.max(-1.5,Math.min(1.5,pitch));camera.rotation.set(pitch,yaw,0)}});
    animate();
}

function createHouse(x,y,z){
    const g=new THREE.Group();
    const w=new THREE.Mesh(new THREE.BoxGeometry(7,4,7),new THREE.MeshLambertMaterial({map:textures.wood}));w.position.y=2;
    const r=new THREE.Mesh(new THREE.ConeGeometry(6,3,4),new THREE.MeshLambertMaterial({color:0x5a3a22}));r.position.y=5.5;r.rotation.y=Math.PI/4;
    g.add(w,r);g.position.set(x,y,z);scene.add(g);
    houses.push({bounds:{minX:x-3.8,maxX:x+3.8,minZ:z-3.8,maxZ:z+3.8}});
}

function setWeapon(t){
    currentWeaponType=t;weaponGroup.clear();
    document.querySelectorAll(".slot").forEach(s=>s.classList.remove("active"));
    document.getElementById(t==="gun"?"slot-0":"slot-1").classList.add("active");
    if(t==="gun"){
        const b=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,0.8),new THREE.MeshLambertMaterial({color:0x333}));
        flash=new THREE.PointLight(0xffaa00,0,4);flash.position.z=-1;weaponGroup.add(b,flash);
        weaponGroup.userData={offset:new THREE.Vector3(0.4,-0.4,-0.6)};
    } else {
        const b=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.8,0.05),new THREE.MeshLambertMaterial({color:0x88ccff}));b.position.y=0.5;
        weaponGroup.add(b);weaponGroup.userData={offset:new THREE.Vector3(0.5,-0.5,-0.8)};
    }
}

function createMob(txt,type){
    const mob=new THREE.Group();
    const mat=new THREE.MeshLambertMaterial({color:type==="skeleton"?0xdddddd:0x5D995D});
    const body=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.75,0.25),mat);body.position.y=1.1;
    const head=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5),new THREE.MeshLambertMaterial({map:textures.face}));head.position.y=1.75;
    mob.add(body,head);mob.castShadow=true;
    if(txt.startsWith("http")){
        const s=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.TextureLoader().load(txt)}));
        s.scale.set(1.5,1.5,1);s.position.y=2.8;mob.add(s);
    } else {
        const d=document.createElement("div");d.className="float-text";d.style.position="absolute";
        renderText(d, txt); document.body.appendChild(d); mob.userData.label = d;
    }
    mob.userData.type=type;mob.userData.hp=1;return mob;
}

function loadQuestion(){
    if(currentQ>=config.questions.length){isWin=true;document.exitPointerLock();document.getElementById("win-screen").style.display="flex";document.getElementById("win-stats").innerHTML=t.done+" Score: "+score;return;}
    targets.forEach(t=>{scene.remove(t.obj);if(t.obj.userData.label)t.obj.userData.label.remove()});targets=[];
    const q=config.questions[currentQ];
    const qt = document.getElementById("q-text"); const qi = document.getElementById("q-img");
    if(q.q.startsWith("http")){qt.style.display="none";qi.src=q.q;qi.style.display="block";}
    else{qt.style.display="block";qi.style.display="none";renderText(qt, q.q);}
    q.a.forEach((ans,i)=>{
        const mob=createMob(ans, Math.random()>0.5?"zombie":"skeleton");
        const a=(i*(Math.PI*2/q.a.length)); mob.position.set(Math.cos(a)*20,0,Math.sin(a)*20);
        scene.add(mob);targets.push({obj:mob,isC:i===q.c});
    });
}

function attack(){
    if(isSwinging)return;isSwinging=true;swingProgress=0;playSound(currentWeaponType==="gun"?"shoot":"hit");
    if(flash){flash.intensity=2;setTimeout(()=>flash.intensity=0,50)}
    const ray=new THREE.Raycaster();ray.setFromCamera(new THREE.Vector2(0,0),camera);
    const hits=ray.intersectObjects(scene.children,true);
    if(hits.length>0){
        let r=hits[0].object;while(r.parent&&r.parent.type!=="Scene")r=r.parent;
        const t=targets.find(tg=>tg.obj===r);
        if(t){
            if(t.isC){score+=100;spawnParticles(r.position,0x00ff00);currentQ++;loadQuestion()}
            else{health--;updateHearts();if(health<=0){isDead=true;document.getElementById("game-over").style.display="flex";document.exitPointerLock()}}
        }
        if(bonuses.includes(r)){scene.remove(r);score+=200;bonuses=bonuses.filter(b=>b!==r);playSound("loot")}
        if(items.includes(r)){scene.remove(r);inventory.push("sword");document.getElementById("slot-1").innerText="üó°Ô∏è";items=items.filter(i=>i!==r);playSound("loot")}
    }
}

function spawnLoot(){
    const geo=new THREE.BoxGeometry(0.8,0.8,0.8);const mat=new THREE.MeshLambertMaterial({map:textures.chest});
    for(let i=0;i<5;i++){const b=new THREE.Mesh(geo,mat);b.position.set(Math.random()*40-20,0.4,Math.random()*40-20);scene.add(b);bonuses.push(b)}
    const sw=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.8,0.05),new THREE.MeshLambertMaterial({color:0x88ccff}));
    sw.position.set(5,0.5,5);scene.add(sw);items.push(sw);
}

function spawnParticles(p,c){for(let i=0;i<10;i++){const m=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,0.2),new THREE.MeshBasicMaterial({color:c}));m.position.copy(p);scene.add(m);particles.push({m,v:new THREE.Vector3((Math.random()-.5),(Math.random()),(Math.random()-.5))})}}
function updateHearts(){document.querySelectorAll(".heart").forEach((h,i)=>h.classList.toggle("lost",i>=health))}
function handleKeys(c,s){if(c==="KeyW")move.fwd=s;if(c==="KeyS")move.bwd=s;if(c==="KeyA")move.left=s;if(c==="KeyD")move.right=s}

function animate(){
    if(isDead||isWin)return;requestAnimationFrame(animate);
    const dt=clock.getDelta();const now=Date.now()/1000;
    const dir=new THREE.Vector3();
    const fwd=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);fwd.y=0;fwd.normalize();
    const rgt=new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);rgt.y=0;rgt.normalize();
    if(move.fwd)dir.add(fwd);if(move.bwd)dir.sub(fwd);if(move.left)dir.sub(rgt);if(move.right)dir.add(rgt);
    if(dir.length()>0)dir.normalize().multiplyScalar((move.sprint?15:8)*dt);
    let nx=camera.position.x+dir.x;let nz=camera.position.z+dir.z;
    let safe=false; houses.forEach(h=>{if(nx>h.bounds.minX&&nx<h.bounds.maxX&&nz>h.bounds.minZ&&nz<h.bounds.maxZ)safe=true;});
    document.getElementById("house-status").style.display=safe?"block":"none";
    camera.position.x=nx;camera.position.z=nz;
    if(move.jump&&player.onGround){player.vel.y=10;player.onGround=false}
    player.vel.y-=30*dt;camera.position.y+=player.vel.y*dt;
    if(camera.position.y<1.7){camera.position.y=1.7;player.vel.y=0;player.onGround=true}
    const off=weaponGroup.userData.offset||new THREE.Vector3(0.5,-0.5,-0.8);
    weaponGroup.position.copy(camera.position);weaponGroup.quaternion.copy(camera.quaternion);
    weaponGroup.translateX(off.x);weaponGroup.translateY(off.y);weaponGroup.translateZ(off.z);
    if(isSwinging){swingProgress+=dt*15;if(swingProgress>=Math.PI){swingProgress=0;isSwinging=false;weaponGroup.rotation.x=0}else{weaponGroup.rotateX(-Math.sin(swingProgress))}}
    targets.forEach(t=>{
        if(t.obj.userData.label){
            const pos=t.obj.position.clone().add(new THREE.Vector3(0,2.5,0));pos.project(camera);
            const x=(pos.x*.5+.5)*window.innerWidth;const y=-(pos.y*.5-.5)*window.innerHeight;
            t.obj.userData.label.style.left=(x-20)+"px";t.obj.userData.label.style.top=y+"px";
            t.obj.userData.label.style.display=(pos.z<1)?"block":"none";
            renderText(t.obj.userData.label, config.questions[currentQ].a[config.questions[currentQ].a.indexOf(t.obj.userData.label.innerText) > -1 ? config.questions[currentQ].a.indexOf(t.obj.userData.label.innerText) : 0]);
        }
        t.obj.lookAt(camera.position.x,0,camera.position.z);
    });
    particles.forEach((p,i)=>{p.m.position.add(p.v);p.v.y-=0.02;if(p.m.position.y<0){scene.remove(p.m);particles.splice(i,1)}});
    renderer.render(scene,camera);
}
document.body.addEventListener("click",()=>{if(audioCtx.state==="suspended")audioCtx.resume();document.body.requestPointerLock()});
window.addEventListener("resize",()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)});
init();
<\/script>
</body>
</html>`;
    }

    // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–ï–í–¨–Æ ---
    function updatePreview() {
        const frame = document.getElementById("preview-frame");
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º data:text/html —á—Ç–æ–±—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É –≤ –ø—Ä–µ–≤—å—é
        frame.src = "data:text/html;charset=utf-8," + encodeURIComponent(getGameHTML());
    }

    // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–î–ê –î–õ–Ø GENIALLY ---
    function generateFinalCode() {
        const code = getGameHTML();
        // –í–ê–ñ–ù–û: –ú—ã –±–µ—Ä–µ–º "—á–∏—Å—Ç—ã–π" –∫–æ–¥ –∏–≥—Ä—ã –∏ –∑–∞–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –µ–≥–æ –≤ Iframe,
        // —Ç–∞–∫ –∫–∞–∫ Genially –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —á–∏—Å—Ç—ã–π HTML, –Ω–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç Iframe.
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º encodeURIComponent –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ–≥–æ —Ç–µ–ª–∞ –∏–≥—Ä—ã –≤ src —Ñ—Ä–µ–π–º–∞.
        const iframeWrap = `<iframe style="width:100%;height:100%;border:none;" src="data:text/html;charset=utf-8,${encodeURIComponent(code)}"></iframe>`;
        
        document.getElementById("final-code").value = iframeWrap;
        document.getElementById("modal").style.display = "flex";
    }

    renderQuestions();
    updatePreview();
</script>
</body>
</html>
