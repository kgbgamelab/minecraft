<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Minecraft Generator for Genially</title>
    <style>
        body { background: #111; color: #eee; font-family: sans-serif; padding: 20px; display: flex; gap: 20px; height: 90vh; }
        .col { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        textarea { background: #222; color: #0f0; border: 1px solid #444; padding: 10px; font-family: monospace; resize: none; flex: 1; }
        input { background: #333; color: white; border: 1px solid #555; padding: 5px; width: 100%; box-sizing: border-box; }
        button { background: #4CAF50; color: white; border: none; padding: 15px; font-size: 18px; cursor: pointer; font-weight: bold; }
        button:hover { background: #45a049; }
        .q-block { background: #222; padding: 10px; border-left: 3px solid #4CAF50; margin-bottom: 10px; }
        h2 { margin: 0 0 10px 0; color: #4CAF50; }
        label { font-size: 12px; color: #aaa; display: block; margin-top: 5px; }
    </style>
</head>
<body>

<div class="col" style="flex: 0 0 400px; overflow-y: auto;">
    <h2>1. Настройка вопросов</h2>
    <div id="questions-list"></div>
    <button onclick="addQuestion()" style="background: #333; border: 1px dashed #777;">+ Добавить вопрос</button>
    <button onclick="generateFinalCode()">2. СГЕНЕРИРОВАТЬ КОД >></button>
</div>

<div class="col">
    <h2>3. Код для Genially (Insert -> Others)</h2>
    <textarea id="output-code" readonly placeholder="Здесь появится код. Нажми кнопку слева."></textarea>
    <button onclick="copyCode()" style="background: #2196F3;">КОПИРОВАТЬ В БУФЕР</button>
</div>

<script type="text/template" id="game-template">
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; user-select: none; }
    canvas { display: block; width: 100%; height: 100%; }
    #ui { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
    #crosshair { position: absolute; top:50%; left:50%; width:20px; height:20px; transform:translate(-50%,-50%); }
    #crosshair::before, #crosshair::after { content:''; position:absolute; background:rgba(255,255,255,0.8); }
    #crosshair::before { top:9px; left:0; width:20px; height:2px; }
    #crosshair::after { top:0; left:9px; width:2px; height:20px; }
    #quest-box { position: absolute; top:20px; width: 100%; text-align: center; }
    #q-text { background: rgba(0,0,0,0.7); color: #ffeb3b; padding: 10px 20px; font-size: 24px; border: 2px solid white; display: inline-block; }
    #hearts { position: absolute; bottom: 20px; left: 20px; font-size: 30px; }
    #msg { position: absolute; top: 40%; width: 100%; text-align: center; font-size: 60px; font-weight: bold; opacity: 0; transition: opacity 0.5s; text-shadow: 2px 2px 0 #000; }
    #overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; pointer-events: auto; }
    .btn { background: #4CAF50; color: white; padding: 15px 30px; font-size: 24px; border: none; cursor: pointer; pointer-events: auto; margin-top: 20px; text-transform: uppercase; }
    .btn:hover { background: #45a049; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script>
</head>
<body>
<div id="ui">
    <div id="quest-box"><div id="q-text">Загрузка...</div></div>
    <div id="crosshair"></div>
    <div id="hearts">❤️❤️❤️❤️❤️</div>
    <div id="msg"></div>
</div>

<div id="overlay">
    <h1 id="title" style="color:white; font-size: 40px;">MINECRAFT QUIZ</h1>
    <p style="color:#aaa;">Кликни, чтобы начать. Используй мышь для обзора.</p>
    <button class="btn" onclick="startGame()">ИГРАТЬ</button>
</div>

<script>
    // === ДАННЫЕ (ВСТАВЛЯЮТСЯ АВТОМАТИЧЕСКИ) ===
    const QUESTIONS = __DATA__;
    
    let scene, camera, renderer, clock;
    let targets = [], particles = [];
    let state = { hp: 5, qIdx: 0, active: false };
    
    // Аудио (синтезатор)
    const actx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(type) {
        if(actx.state === 'suspended') actx.resume();
        const osc = actx.createOscillator();
        const gain = actx.createGain();
        osc.connect(gain); gain.connect(actx.destination);
        const t = actx.currentTime;
        if(type==='hit') { osc.type='square'; osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(40, t+0.1); gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.1); osc.start(t); osc.stop(t+0.1); }
        if(type==='win') { osc.type='sine'; osc.frequency.setValueAtTime(600, t); osc.frequency.setValueAtTime(900, t+0.1); gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.3); osc.start(t); osc.stop(t+0.3); }
        if(type==='lose') { osc.type='sawtooth'; osc.frequency.setValueAtTime(100, t); gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0, t+0.3); osc.start(t); osc.stop(t+0.3); }
    }

    // Текстуры (процедурные)
    function createTex(color) {
        const c = document.createElement('canvas'); c.width=64; c.height=64;
        const ctx = c.getContext('2d');
        ctx.fillStyle = color; ctx.fillRect(0,0,64,64);
        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        for(let i=0; i<30; i++) ctx.fillRect(Math.random()*64, Math.random()*64, 4, 4);
        const t = new THREE.CanvasTexture(c); t.magFilter = THREE.NearestFilter; return t;
    }
    const mats = {
        grass: new THREE.MeshLambertMaterial({ map: createTex('#5da34b') }),
        dirt: new THREE.MeshLambertMaterial({ map: createTex('#5d4037') }),
        wood: new THREE.MeshLambertMaterial({ map: createTex('#8B4513') }),
        sky: new THREE.Color(0x87CEEB)
    };

    function init() {
        scene = new THREE.Scene(); scene.background = mats.sky; 
        scene.fog = new THREE.Fog(mats.sky, 10, 50);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
        
        renderer = new THREE.WebGLRenderer({antialias:false});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        const sun = new THREE.DirectionalLight(0xffffff, 0.8); sun.position.set(20,50,30); scene.add(sun);
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        
        // Пол
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(100,100), mats.grass);
        floor.rotation.x = -Math.PI/2; scene.add(floor);
        
        // Стены (декор)
        for(let i=0; i<20; i++) {
            const h = new THREE.Mesh(new THREE.BoxGeometry(1, Math.random()*3+1, 1), mats.wood);
            h.position.set(Math.random()*40-20, h.geometry.parameters.height/2, Math.random()*40-20);
            if(h.position.length() > 5) scene.add(h);
        }

        clock = new THREE.Clock();
        animate();
        
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        
        document.addEventListener('mousedown', () => {
            if(!state.active) return;
            if(!document.pointerLockElement) document.body.requestPointerLock();
            else shoot();
        });
        
        document.addEventListener('mousemove', (e) => {
            if(document.pointerLockElement) {
                camera.rotation.y -= e.movementX * 0.003;
                camera.rotation.x -= e.movementY * 0.003;
                camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
            }
        });
    }

    function startGame() {
        document.getElementById('overlay').style.display = 'none';
        state.active = true;
        loadQuestion();
        document.body.requestPointerLock();
    }

    function loadQuestion() {
        if(state.qIdx >= QUESTIONS.length) { endGame(true); return; }
        
        targets.forEach(t => scene.remove(t)); targets = [];
        const q = QUESTIONS[state.qIdx];
        document.getElementById('q-text').innerText = q.q;
        
        q.a.forEach((ans, i) => {
            const group = new THREE.Group();
            
            // Тело моба
            const body = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshLambertMaterial({color: 0x3C50C4}));
            body.position.y = 1;
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), new THREE.MeshLambertMaterial({color: 0xffccaa}));
            head.position.y = 2.4;
            
            // Текст над головой
            const cv = document.createElement('canvas'); cv.width=256; cv.height=64;
            const ctx = cv.getContext('2d'); 
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,256,64);
            ctx.fillStyle = 'white'; ctx.font = 'bold 30px Arial'; ctx.textAlign='center'; ctx.fillText(ans, 128, 42);
            const sp = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(cv) }));
            sp.position.y = 3.5; sp.scale.set(3, 0.75, 1);
            
            group.add(body, head, sp);
            
            const angle = (i / q.a.length) * Math.PI * 2;
            group.position.set(Math.cos(angle)*10, 0, Math.sin(angle)*10);
            group.lookAt(camera.position);
            
            group.userData = { correct: i === q.c };
            scene.add(group); targets.push(group);
        });
    }

    function shoot() {
        beep('hit');
        // Анимация удара
        camera.position.z -= 0.1; setTimeout(()=>camera.position.z+=0.1, 50);
        
        const ray = new THREE.Raycaster();
        ray.setFromCamera(new THREE.Vector2(0,0), camera);
        const hits = ray.intersectObjects(targets, true);
        
        if(hits.length > 0) {
            let root = hits[0].object;
            while(root.parent && root.parent.type !== 'Scene') root = root.parent;
            
            if(root.userData.correct) {
                beep('win');
                showMsg("ВЕРНО!", "#4CAF50");
                state.qIdx++;
                setTimeout(loadQuestion, 1000);
            } else {
                beep('lose');
                state.hp--;
                document.getElementById('hearts').innerText = "❤️".repeat(state.hp);
                showMsg("ОШИБКА!", "#f44336");
                if(state.hp <= 0) endGame(false);
            }
        }
    }
    
    function showMsg(text, color) {
        const m = document.getElementById('msg');
        m.innerText = text; m.style.color = color; m.style.opacity = 1;
        setTimeout(() => m.style.opacity = 0, 1000);
    }

    function endGame(win) {
        state.active = false;
        document.exitPointerLock();
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('title').innerText = win ? "ПОБЕДА!" : "GAME OVER";
        document.getElementById('title').style.color = win ? "#4CAF50" : "#f44336";
        document.querySelector('.btn').innerText = "ЗАНОВО";
        document.querySelector('.btn').onclick = () => location.reload();
    }

    function animate() {
        requestAnimationFrame(animate);
        targets.forEach(t => t.lookAt(camera.position));
        renderer.render(scene, camera);
    }

    init();
<\/script>
</body>
</html>
</script>


<script>
    let questions = [{ q: "2 + 2 = ?", a: ["3", "4", "5"], c: 1 }];

    function renderList() {
        const div = document.getElementById('questions-list');
        div.innerHTML = '';
        questions.forEach((q, i) => {
            let answersHtml = '';
            q.a.forEach((ans, ai) => {
                answersHtml += `
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="radio" name="q${i}" ${q.c===ai?'checked':''} onchange="questions[${i}].c=${ai}" style="width:20px;">
                    <input value="${ans}" oninput="questions[${i}].a[${ai}]=this.value" placeholder="Ответ">
                </div>`;
            });

            div.innerHTML += `
            <div class="q-block">
                <div style="display:flex; justify-content:space-between;">
                    <label>Вопрос ${i+1}</label>
                    <button onclick="delQ(${i})" style="padding:2px 5px; font-size:10px; background:#d32f2f;">Удалить</button>
                </div>
                <input value="${q.q}" oninput="questions[${i}].q=this.value" placeholder="Текст вопроса">
                <label>Варианты (отметь верный):</label>
                ${answersHtml}
            </div>`;
        });
    }

    function addQuestion() { questions.push({q:"", a:["","",""], c:0}); renderList(); }
    function delQ(i) { if(questions.length>1) { questions.splice(i,1); renderList(); } }

    function generateFinalCode() {
        // 1. Берем шаблон игры
        let template = document.getElementById('game-template').innerHTML;
        
        // 2. Вставляем вопросы (JSON)
        // .replace(/&lt;/g, '<') исправляет баг, если браузер экранировал шаблон
        template = template.replace('__DATA__', JSON.stringify(questions));

        // 3. Кодируем в Base64 (ЧТОБЫ GENIALLY НЕ ЛОМАЛ КАВЫЧКИ)
        // Используем кодировку UTF-8
        const base64Game = btoa(unescape(encodeURIComponent(template)));

        // 4. Создаем загрузчик для Genially
        const loaderCode = `
<div id="game-container" style="width:100%; height:100%; overflow:hidden;"></div>
<script>
(function() {
    // Распаковка игры из Base64
    var b64 = "${base64Game}";
    var html = decodeURIComponent(escape(window.atob(b64)));
    
    // Создание Blob URL
    var blob = new Blob([html], {type: 'text/html'});
    var url = URL.createObjectURL(blob);
    
    // Создание iframe
    var ifr = document.createElement('iframe');
    ifr.src = url;
    ifr.style.width = "100%";
    ifr.style.height = "100%";
    ifr.style.border = "none";
    ifr.allow = "autoplay; fullscreen; pointer-lock";
    
    document.getElementById('game-container').appendChild(ifr);
})();
<\/script>
`.trim();

        document.getElementById('output-code').value = loaderCode;
    }

    function copyCode() {
        const ta = document.getElementById('output-code');
        ta.select();
        document.execCommand('copy');
        alert("Код скопирован! Вставляй в Genially.");
    }

    renderList();
</script>

</body>
</html>
