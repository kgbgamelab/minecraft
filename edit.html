<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>KGB Minecraft Builder (Final Fix)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* –°–¢–ò–õ–ò –†–ï–î–ê–ö–¢–û–†–ê */
        body { margin: 0; background: #121212; color: #eee; font-family: 'Roboto', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { background: #000; padding: 10px 20px; border-bottom: 2px solid #55ff55; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-family: 'VT323'; color: #55ff55; margin: 0; font-size: 28px; letter-spacing: 2px; }
        .main { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 400px; background: #1e1e1e; border-right: 1px solid #333; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .preview { flex: 1; background: #000; position: relative; }
        
        /* –ì–õ–ê–í–ù–û–ï: –§—Ä–µ–π–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        iframe#preview-frame { width: 100%; height: 100%; border: none; background: #000; }

        input, select { width: 100%; background: #2d2d2d; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 4px; box-sizing: border-box; font-family: 'VT323'; font-size: 18px; margin-bottom: 5px; }
        .q-card { background: #252525; padding: 15px; border: 1px solid #444; border-radius: 6px; position: relative; }
        .btn { background: #55ff55; color: #000; border: none; padding: 10px 20px; font-family: 'VT323'; font-size: 20px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn:hover { background: #44ee44; }
        .btn-add { background: transparent; color: #87CEEB; border: 2px dashed #87CEEB; margin-top: 10px; }
        .btn-update { position: absolute; top: 20px; right: 20px; width: auto; z-index: 100; box-shadow: 0 4px 0 #004400; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∫–æ–¥–æ–º */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; align-items: center; justify-content: center; flex-direction: column; }
        .code-box { width: 70%; height: 60%; background: #111; color: #55ff55; border: 2px solid #555; padding: 15px; font-family: monospace; resize: none; }
    </style>
</head>
<body>

<header>
    <h1>MINECRAFT BUILDER (BLOB CORE)</h1>
    <button class="btn" style="width: auto;" onclick="generateFinalCode()">–ü–û–õ–£–ß–ò–¢–¨ –ö–û–î</button>
</header>

<div class="main">
    <div class="sidebar">
        <label>–Ø–∑—ã–∫ / Language</label>
        <select id="lang">
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="en">English</option>
            <option value="de">Deutsch</option>
            <option value="es">Espa√±ol</option>
        </select>
        <div id="q-list"></div>
        <button class="btn btn-add" onclick="addQuestion()">+ –í–û–ü–†–û–°</button>
    </div>
    <div class="preview">
        <button class="btn btn-update" onclick="updatePreview()">üîÑ –û–ë–ù–û–í–ò–¢–¨ –ò–ì–†–£</button>
        <iframe id="preview-frame"></iframe>
    </div>
</div>

<div id="modal" class="modal">
    <h2 style="color:white; font-family:VT323">–ö–û–î –î–õ–Ø GENIALLY</h2>
    <textarea id="final-code" class="code-box" readonly onclick="this.select()"></textarea>
    <button class="btn" style="width: 200px; margin-top:10px;" onclick="document.getElementById('modal').style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
</div>

<script>
    // ---------------------------------------------------------
    // 1. –ü–û–õ–ù–´–ô –ò–°–•–û–î–ù–´–ô –ö–û–î –ò–ì–†–´ (–ö–ê–ö –¢–ï–ö–°–¢–û–í–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø)
    // ---------------------------------------------------------
    // –ú—ã —Ö—Ä–∞–Ω–∏–º –∏–≥—Ä—É –∫–∞–∫ —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Ç–µ–≥–æ–≤.
    const BASE_GAME_CODE = `
<!DOCTYPE html>
<html lang="__LANG__">
<head>
<meta charset="UTF-8">
<title>MC Game</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script>
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<style>
body{margin:0;overflow:hidden;background:#87CEEB;font-family:'VT323',monospace;user-select:none}
#hud{position:absolute;width:100%;height:100%;pointer-events:none}
.float-text{position:absolute;color:#ffff55;font-size:40px;font-weight:bold;text-shadow:3px 3px 0 #000;pointer-events:none;animation:floatUp 1s forwards;white-space:nowrap}
@keyframes floatUp{to{transform:translateY(-120px) scale(1.2);opacity:0}}
#crosshair{position:absolute;top:50%;left:50%;width:24px;height:24px;transform:translate(-50%,-50%);mix-blend-mode:difference}
#crosshair::before{content:'';position:absolute;top:11px;left:0;width:24px;height:2px;background:white}
#crosshair::after{content:'';position:absolute;top:0;left:11px;width:2px;height:24px;background:white}
#bottom-ui{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);width:600px;text-align:center}
.hearts{display:flex;gap:4px;justify-content:center;margin-bottom:5px}
.heart{width:32px;height:32px;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10"><path fill="%23ff0000" stroke="black" stroke-width="0.5" d="M2 1h2v1h2V1h2v2H7v1H6v1H5v1H4V5H3V4H2V2h2z"/></svg>');background-size:contain;image-rendering:pixelated}
.heart.lost{filter:grayscale(100%) brightness(0.3)}
#xp-bar{width:100%;height:16px;background:#222;border:3px solid #000;position:relative;margin-bottom:10px}
#xp-fill{height:100%;background:linear-gradient(to right,#00ff00,#55ff55);width:0%;transition:width 0.2s}
#xp-info{position:absolute;top:-35px;width:100%;color:#80ff00;font-size:30px;text-shadow:2px 2px 0 #000;display:flex;justify-content:space-around}
#hotbar{display:flex;justify-content:center;gap:4px;background:rgba(0,0,0,0.6);padding:5px;border:2px solid #fff;border-radius:4px}
.slot{width:60px;height:60px;background:#8b8b8b;border:4px solid #373737;border-top-color:#ddd;border-left-color:#ddd;display:flex;align-items:center;justify-content:center;font-size:30px;color:white}
.slot.active{border-color:white;background:#a0a0a0;transform:scale(1.1)}
#quest-box{position:absolute;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:15px 40px;border:3px solid #fff;color:white;text-align:center;min-width:300px}
#q-text{font-size:32px;color:#ffff55;text-shadow:2px 2px 0 #333}
#q-img{max-height:150px;border:2px solid white;margin-top:10px;display:none}
#damage-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:red;opacity:0;pointer-events:none;transition:opacity 0.1s}
#game-over,#win-screen{display:none;position:absolute;top:0;left:0;width:100%;height:100%;flex-direction:column;align-items:center;justify-content:center;color:white;z-index:999;background:rgba(0,0,0,0.9)}
.btn-respawn{font-size:40px;cursor:pointer;color:#ffff55;text-decoration:underline;margin-top:20px}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"><\/script>
</head>
<body>
<div id="damage-overlay"></div>
<div id="hud">
    <div id="quest-box"><div id="lbl-q" style="color:#aaa;font-size:18px;letter-spacing:2px">Q</div><div id="q-text">Loading...</div><img id="q-img" src=""></div>
    <div id="crosshair"></div>
    <div id="bottom-ui">
        <div id="xp-info"><span>XP: <span id="lvl-num">0</span></span><span style="color:#ffd700">COMBO: x<span id="combo-num">0</span></span></div>
        <div class="hearts" id="hearts-container"><div class="heart"></div><div class="heart"></div><div class="heart"></div><div class="heart"></div><div class="heart"></div></div>
        <div id="xp-bar"><div id="xp-fill"></div></div>
        <div id="hotbar"><div class="slot active" id="slot-0">üî´</div><div class="slot" id="slot-1"></div></div>
    </div>
</div>
<div id="game-over"><h1 style="font-size:100px;margin:0;color:#ff5555">YOU DIED</h1><p class="btn-respawn" onclick="location.reload()">Respawn</p></div>
<div id="win-screen"><h1 style="font-size:80px;margin:0;color:#55ff55">QUEST COMPLETE!</h1><div id="win-stats" style="font-size:35px;text-align:center;margin:20px"></div><p class="btn-respawn" onclick="location.reload()">Play Again</p></div>

<script>
// CONFIGURATION INJECTION
const config = __CONFIG__;

// TRANSLATIONS
const tr={ru:{q:"–¢–ï–ö–£–©–ò–ô –í–û–ü–†–û–°",done:"–í—ã –ø—Ä–æ—à–ª–∏!"},en:{q:"CURRENT QUESTION",done:"Well done!"},de:{q:"FRAGE",done:"Gut!"},es:{q:"PREGUNTA",done:"¬°Bien!"}};
const t=tr[config.lang]||tr.en;
document.getElementById("lbl-q").innerText=t.q;

let scene,camera,renderer,weaponGroup,flash,score=0,currentQ=0,health=5,combo=0;
let targets=[],particles=[],bonuses=[],items=[],projectiles=[],houses=[];
let move={fwd:false,bwd:false,left:false,right:false,sprint:false,jump:false};
let player={vel:new THREE.Vector3(),onGround:false,speed:0};
let pitch=0,yaw=0,isDead=false,isWin=false,isSwinging=false,swingProgress=0;
let currentWeaponType="gun",inventory=["gun"];
const clock=new THREE.Clock();const audioCtx=new(window.AudioContext||window.webkitAudioContext)();

function createTexture(type){
    const canvas=document.createElement("canvas");canvas.width=64;canvas.height=64;const ctx=canvas.getContext("2d");
    const fillNoise=(c)=>{ctx.fillStyle=c;ctx.fillRect(0,0,64,64);for(let i=0;i<400;i++){ctx.fillStyle="rgba(0,0,0,0.1)";ctx.fillRect(Math.random()*64,Math.random()*64,4,4)}};
    if(type==="grass"){fillNoise("#5da34b");ctx.fillStyle="#4a8f3a";for(let i=0;i<50;i++)ctx.fillRect(Math.random()*60,Math.random()*60,4,4)}
    if(type==="wood"){ctx.fillStyle="#5c4033";ctx.fillRect(0,0,64,64);ctx.fillStyle="#4a332a";for(let i=1;i<4;i++)ctx.fillRect(i*16,0,4,64)}
    if(type==="leaves"){fillNoise("#2d5a27");ctx.fillStyle="#3e7a37";for(let i=0;i<60;i++)ctx.fillRect(Math.random()*60,Math.random()*60,6,6)}
    if(type==="planks"){ctx.fillStyle="#a07040";ctx.fillRect(0,0,64,64);ctx.fillStyle="#805020";ctx.fillRect(0,0,64,2);ctx.fillRect(0,20,64,2);ctx.fillRect(0,40,64,2)}
    if(type==="face"){fillNoise("#bcaea5");ctx.fillStyle="#222";ctx.fillRect(10,20,12,12);ctx.fillRect(42,20,12,12);ctx.fillStyle="#633";ctx.fillRect(20,45,24,8)}
    const tex=new THREE.CanvasTexture(canvas);tex.magFilter=THREE.NearestFilter;return tex;
}
const textures={grass:createTexture("grass"),wood:createTexture("wood"),planks:createTexture("planks"),face:createTexture("face"),leaves:createTexture("leaves")};

function playSound(type){
    if(audioCtx.state==="suspended")audioCtx.resume();
    const t=audioCtx.currentTime; const g=audioCtx.createGain();g.connect(audioCtx.destination);
    const osc=audioCtx.createOscillator();osc.connect(g);
    if(type==="shoot"){osc.type="sawtooth";osc.frequency.setValueAtTime(1200,t);osc.frequency.exponentialRampToValueAtTime(100,t+0.15);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.15);osc.start();osc.stop(t+0.15)}
    else{osc.type="sawtooth";osc.frequency.setValueAtTime(100,t);g.gain.setValueAtTime(0.5,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);osc.start();osc.stop(t+0.2)}
}

function init(){
    scene=new THREE.Scene();scene.background=new THREE.Color(0x87CEEB);scene.fog=new THREE.Fog(0x87CEEB,20,80);
    camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.1,1000);camera.rotation.order="YXZ";
    weaponGroup=new THREE.Group();scene.add(weaponGroup);
    renderer=new THREE.WebGLRenderer({antialias:false});renderer.setSize(window.innerWidth,window.innerHeight);
    renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;document.body.appendChild(renderer.domElement);
    
    const amb=new THREE.AmbientLight(0xffffff,0.5);scene.add(amb);
    const sun=new THREE.DirectionalLight(0xffffff,0.8);sun.position.set(50,100,50);sun.castShadow=true;scene.add(sun);
    
    const floor=new THREE.Mesh(new THREE.PlaneGeometry(300,300),new THREE.MeshLambertMaterial({map:textures.grass}));
    floor.rotation.x=-Math.PI/2;floor.receiveShadow=true;floor.material.map.wrapS=floor.material.map.wrapT=THREE.RepeatWrapping;floor.material.map.repeat.set(100,100);scene.add(floor);
    
    createHouse(20,0,20);createHouse(-30,0,-30);createHouse(40,0,-10);
    for(let i=0;i<40;i++){const x=Math.random()*200-100;const z=Math.random()*200-100;if(Math.abs(x)>10||Math.abs(z)>10)createTree(x,z)}
    
    setWeapon("gun");loadQuestion();
    
    document.addEventListener("keydown",e=>{if(isDead||isWin)return;if(e.code==="Space")move.jump=true;if(e.code==="ShiftLeft")move.sprint=true;handleKeys(e.code,true)});
    document.addEventListener("keyup",e=>{if(e.code==="Space")move.jump=false;if(e.code==="ShiftLeft")move.sprint=false;handleKeys(e.code,false)});
    document.addEventListener("mousedown",attack);
    document.addEventListener("mousemove",e=>{if(document.pointerLockElement&&!isDead&&!isWin){yaw-=e.movementX*0.002;pitch-=e.movementY*0.002;pitch=Math.max(-1.5,Math.min(1.5,pitch));camera.rotation.set(pitch,yaw,0)}});
    window.addEventListener("resize",()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)});
    animate();
}

function createHouse(x,y,z){
    const g=new THREE.Group();
    const w=new THREE.Mesh(new THREE.BoxGeometry(7,4,7),new THREE.MeshLambertMaterial({map:textures.wood}));w.position.y=2;
    const r=new THREE.Mesh(new THREE.ConeGeometry(6,3,4),new THREE.MeshLambertMaterial({color:0x5a3a22}));r.position.y=5.5;r.rotation.y=Math.PI/4;
    g.add(w,r);g.position.set(x,y,z);scene.add(g);
    houses.push({bounds:{minX:x-3.8,maxX:x+3.8,minZ:z-3.8,maxZ:z+3.8}});
}
function createTree(x,z){const g=new THREE.Group();const t=new THREE.Mesh(new THREE.BoxGeometry(1,5,1),new THREE.MeshLambertMaterial({map:textures.wood}));t.position.y=2.5;t.castShadow=true;g.add(t);const l=new THREE.Mesh(new THREE.BoxGeometry(3,3,3),new THREE.MeshLambertMaterial({map:textures.leaves,color:0x2d5a27}));l.position.y=5;g.add(l);g.position.set(x,0,z);scene.add(g)}

function setWeapon(t){
    currentWeaponType=t;weaponGroup.clear();
    const b=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,0.8),new THREE.MeshLambertMaterial({color:0x333}));
    flash=new THREE.PointLight(0xffaa00,0,4);flash.position.z=-1;weaponGroup.add(b,flash);
    weaponGroup.userData={offset:new THREE.Vector3(0.4,-0.4,-0.6)};
    document.getElementById("slot-0").classList.add("active");
}

function renderText(el,txt){if(txt.includes("$")){try{katex.render(txt.replace(/\\$/g,""),el,{throwOnError:false})}catch(e){el.innerText=txt}}else{el.innerText=txt}}

function createMob(txt,type){
    const m=new THREE.Group();
    const mat=new THREE.MeshLambertMaterial({color:0x5D995D});
    const body=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.75,0.25),mat);body.position.y=1.1;
    const head=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5),new THREE.MeshLambertMaterial({map:textures.face}));head.position.y=1.75;
    m.add(body,head);m.castShadow=true;
    
    if(txt.startsWith("http")){
        const map=new THREE.TextureLoader().load(txt);map.magFilter=THREE.NearestFilter;
        const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:map}));sp.scale.set(1.5,1.5,1);sp.position.y=2.6;m.add(sp);
    } else {
        const d=document.createElement("div");
        d.style.position="absolute";d.style.color="#ffff55";d.style.fontSize="40px";d.style.fontWeight="bold";d.style.textShadow="2px 2px 0 #000";d.style.whiteSpace="nowrap";
        renderText(d,txt);document.body.appendChild(d);m.userData.label=d;
    }
    m.userData={isAggro:false,aggroTimer:0};return m;
}

function loadQuestion(){
    if(currentQ>=config.questions.length){isWin=true;document.exitPointerLock();document.getElementById("win-screen").style.display="flex";document.getElementById("win-stats").innerHTML=t.done+" Score: "+score;return}
    targets.forEach(t=>{scene.remove(t.obj);if(t.obj.userData.label)t.obj.userData.label.remove()});targets=[];
    const q=config.questions[currentQ];
    const qt=document.getElementById("q-text");const qi=document.getElementById("q-img");
    if(q.q.startsWith("http")){qt.style.display="none";qi.src=q.q;qi.style.display="block"}else{qt.style.display="block";qi.style.display="none";renderText(qt,q.q)}
    q.a.forEach((ans,i)=>{
        const m=createMob(ans);
        const a=(i*(Math.PI*2/q.a.length));const r=22;m.position.set(Math.cos(a)*r,0,Math.sin(a)*r);
        scene.add(m);targets.push({obj:m,isC:i===q.c});
    });
}

function attack(){
    if(isDead||isWin||isSwinging)return;isSwinging=true;swingProgress=0;playSound("shoot");
    if(flash){flash.intensity=2;setTimeout(()=>flash.intensity=0,50)}
    const ray=new THREE.Raycaster();ray.setFromCamera(new THREE.Vector2(0,0),camera);
    const hits=ray.intersectObjects(scene.children,true);
    if(hits.length>0){
        let hit=hits[0].object;while(hit.parent&&hit.type!=="Group")hit=hit.parent;
        const t=targets.find(x=>x.obj===hit);
        if(t){
            if(t.isC){score+=100;combo++;document.getElementById("lvl-num").innerText=score;document.getElementById("combo-num").innerText=combo;currentQ++;loadQuestion()}
            else{combo=0;health--;document.querySelectorAll(".heart")[health].classList.add("lost");if(health<=0){isDead=true;document.getElementById("game-over").style.display="flex";document.exitPointerLock()}}
        }
    }
}

function handleKeys(c,s){if(c==="KeyW")move.fwd=s;if(c==="KeyS")move.bwd=s;if(c==="KeyA")move.left=s;if(c==="KeyD")move.right=s}
function updatePhysics(dt){
    player.speed=move.sprint?18:10;
    const dir=new THREE.Vector3();const fwd=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);fwd.y=0;fwd.normalize();const rgt=new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);rgt.y=0;rgt.normalize();
    if(move.fwd)dir.add(fwd);if(move.bwd)dir.sub(fwd);if(move.left)dir.sub(rgt);if(move.right)dir.add(rgt);
    if(dir.length()>0)dir.normalize().multiplyScalar(player.speed*dt);
    if(player.onGround&&move.jump){player.vel.y=12;player.onGround=false}player.vel.y-=30*dt;
    let nx=camera.position.x+dir.x+player.vel.x*dt;let nz=camera.position.z+dir.z+player.vel.z*dt;
    let safe=false;houses.forEach(h=>{if(nx>h.bounds.minX&&nx<h.bounds.maxX&&nz>h.bounds.minZ&&nz<h.bounds.maxZ)safe=true});
    camera.position.x=nx;camera.position.z=nz;
    camera.position.y+=player.vel.y*dt;if(camera.position.y<1.7){camera.position.y=1.7;player.vel.y=0;player.onGround=true}
    player.vel.x*=0.9;player.vel.z*=0.9;
    const off=weaponGroup.userData.offset;weaponGroup.position.copy(camera.position);weaponGroup.quaternion.copy(camera.quaternion);weaponGroup.translateX(off.x);weaponGroup.translateY(off.y);weaponGroup.translateZ(off.z);
    if(isSwinging){swingProgress+=dt*15;if(swingProgress>=Math.PI){swingProgress=0;isSwinging=false;weaponGroup.rotation.x=0}else weaponGroup.position.z+=Math.sin(swingProgress)*0.1}
    targets.forEach(t=>{
        const m=t.obj;if(m.userData.label){
            const pos=m.position.clone().add(new THREE.Vector3(0,2.5,0));pos.project(camera);
            const x=(pos.x*.5+.5)*window.innerWidth;const y=-(pos.y*.5-.5)*window.innerHeight;
            m.userData.label.style.left=(x-20)+"px";m.userData.label.style.top=y+"px";
            m.userData.label.style.display=(pos.z<1)?"block":"none";
        }
        m.lookAt(camera.position.x,0,camera.position.z);
    });
    renderer.render(scene,camera);
}
function animate(){requestAnimationFrame(animate);if(isDead||isWin)return;updatePhysics(clock.getDelta())}
document.body.addEventListener("click",()=>{if(audioCtx.state==="suspended")audioCtx.resume();if(!isDead&&!isWin)document.body.requestPointerLock()});
init();
<\/script>
</body>
</html>
`;

    // ---------------------------------------------------------
    // 2. –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–û–†–ê
    // ---------------------------------------------------------
    let questions = [{ q: "2 + 2 = $4$", a: ["$4$", "$5$", "$6$"], c: 0 }];

    function renderQuestions() {
        const c = document.getElementById('q-list');
        c.innerHTML = '';
        questions.forEach((q, i) => {
            let ansHtml = '';
            q.a.forEach((ans, ai) => {
                ansHtml += `
                <div class="ans-row">
                    <input type="radio" name="q${i}" ${q.c === ai ? 'checked' : ''} onchange="updQ(${i}, 'c', ${ai})">
                    <input type="text" value="${ans.replace(/"/g, '&quot;')}" oninput="updQ(${i}, 'a', ${ai}, this.value)" placeholder="–û—Ç–≤–µ—Ç ${ai+1}">
                </div>`;
            });
            c.innerHTML += `
            <div class="q-card">
                <button class="btn-del" onclick="delQ(${i})">X</button>
                <label>–í–æ–ø—Ä–æ—Å ${i+1}</label>
                <input type="text" value="${q.q.replace(/"/g, '&quot;')}" oninput="updQ(${i}, 'q', null, this.value)" placeholder="–¢–µ–∫—Å—Ç, $–§–æ—Ä–º—É–ª–∞$ –∏–ª–∏ URL">
                <label style="margin-top:10px">–í–∞—Ä–∏–∞–Ω—Ç—ã (–ú–æ–±—ã)</label>
                ${ansHtml}
            </div>`;
        });
    }

    function addQuestion() { questions.push({ q: "–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å", a: ["A", "B", "C"], c: 0 }); renderQuestions(); }
    function delQ(i) { if(questions.length > 1) { questions.splice(i, 1); renderQuestions(); } }
    function updQ(i, type, idx, val) {
        if(type === 'q') questions[i].q = val;
        if(type === 'c') questions[i].c = idx;
        if(type === 'a') questions[i].a[idx] = val;
    }

    // --- –°–ë–û–†–ö–ê –ò–ì–†–´ ---
    function buildGameString() {
        const lang = document.getElementById('lang').value;
        const configStr = JSON.stringify({ lang: lang, questions: questions });
        
        let code = BASE_GAME_CODE;
        code = code.replace('__LANG__', lang);
        code = code.replace('__CONFIG__', configStr);
        return code;
    }

    // --- –ü–†–ï–î–ü–†–û–°–ú–û–¢–† (–ß–ï–†–ï–ó BLOB) ---
    function updatePreview() {
        const gameHtml = buildGameString();
        const blob = new Blob([gameHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        document.getElementById('preview-frame').src = url;
    }

    // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–î–ê –î–õ–Ø GENIALLY (BLOB METHOD) ---
    function generateFinalCode() {
        // –ë–µ—Ä–µ–º –∫–æ–¥ –∏–≥—Ä—ã
        let gameCode = buildGameString();
        
        // –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–ò–ï –î–õ–Ø –í–°–¢–ê–í–ö–ò –í JS –°–¢–†–û–ö–£
        // –≠—Ç–æ —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π —à–∞–≥, —á—Ç–æ–±—ã Genially –Ω–µ —Å–ª–æ–º–∞–ª –∫–æ–¥
        gameCode = gameCode.replace(/\\/g, '\\\\')  // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ª—ç—à–∏
                           .replace(/`/g, '\\`')    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
                           .replace(/\${/g, '\\${'); // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º ${}

        // –®–∞–±–ª–æ–Ω "–û–≤–µ—á–∫–∏"
        const finalSnippet = `
<iframe id="game-frame" style="width:100%; height:100%; border:none;" allow="autoplay; pointer-lock"></iframe>
<script>
const exactGameCode = \`${gameCode}\`;
const blob = new Blob([exactGameCode], { type: 'text/html' });
const url = URL.createObjectURL(blob);
document.getElementById('game-frame').src = url;
<\/script>
        `.trim();

        document.getElementById('final-code').value = finalSnippet;
        document.getElementById('modal').style.display = 'flex';
    }

    // –ó–∞–ø—É—Å–∫
    renderQuestions();
    updatePreview();
</script>
</body>
</html>
