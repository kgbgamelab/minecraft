<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Minecraft Editor (Blob Version)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #121212; color: #eee; font-family: 'Roboto', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        header { background: #000; padding: 15px 20px; border-bottom: 2px solid #55ff55; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-family: 'VT323'; color: #55ff55; margin: 0; font-size: 28px; text-shadow: 2px 2px 0 #003300; }
        
        /* LAYOUT */
        .main { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 400px; background: #1e1e1e; border-right: 1px solid #333; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        .preview { flex: 1; background: #000; padding: 20px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* IFRAME –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–ê */
        #preview-container { width: 100%; height: 100%; border: 4px solid #55ff55; background: #87CEEB; box-shadow: 0 0 20px rgba(85,255,85,0.1); }
        iframe { width: 100%; height: 100%; border: none; }

        /* –≠–õ–ï–ú–ï–ù–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        label { color: #888; font-size: 12px; margin-bottom: 4px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        input, select { width: 100%; background: #2d2d2d; border: 1px solid #444; color: #fff; padding: 10px; margin-bottom: 5px; border-radius: 4px; box-sizing: border-box; font-family: 'VT323'; font-size: 18px; }
        input:focus { border-color: #55ff55; outline: none; }

        /* –ö–ê–†–¢–û–ß–ö–ò –í–û–ü–†–û–°–û–í */
        .q-card { background: #252525; padding: 15px; border-radius: 6px; border: 1px solid #444; position: relative; }
        .btn-del { position: absolute; top: 10px; right: 10px; background: #d32f2f; color: white; border: none; cursor: pointer; padding: 2px 8px; border-radius: 3px; font-family: 'VT323'; font-size: 16px; }
        .ans-row { display: flex; gap: 10px; align-items: center; margin-top: 8px; }
        .ans-row input[type="radio"] { width: auto; transform: scale(1.5); accent-color: #55ff55; cursor: pointer; }

        /* –ö–ù–û–ü–ö–ò */
        .btn { background: #55ff55; color: #000; border: none; padding: 10px 25px; font-family: 'VT323'; font-size: 22px; cursor: pointer; text-transform: uppercase; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        .btn:hover { background: #44ee44; box-shadow: 0 0 10px rgba(85,255,85,0.4); }
        .btn-add { background: transparent; color: #87CEEB; border: 2px dashed #87CEEB; width: 100%; margin-top: 10px; }
        .btn-add:hover { background: rgba(135, 206, 235, 0.1); }
        .btn-update { position: absolute; top: 30px; right: 30px; z-index: 100; font-size: 18px; padding: 5px 15px; box-shadow: 0 4px 0 #004400; }
        .btn-update:active { transform: translateY(4px); box-shadow: none; }

        /* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; flex-direction: column; }
        .code-box { width: 70%; height: 60%; background: #111; color: #55ff55; border: 2px solid #555; padding: 20px; font-family: monospace; resize: none; margin-bottom: 20px; font-size: 14px; }
        
        footer { background: #000; padding: 10px; text-align: center; font-family: 'VT323'; color: #666; border-top: 1px solid #333; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:15px;">
        <img src="https://con.xl.ru/fnfLZuvpAUiDaqDs8d1-2g/images/kcJYv7OsYUSGt5AfGq5jIw.png" height="45">
        <div>
            <h1>MINECRAFT GENIALLY BUILDER</h1>
            <span style="font-size:12px; color:#888;">–§–û–†–ú–ê–¢ "BLOB" (–ö–ê–ö –í –û–í–ï–ß–ö–ï)</span>
        </div>
    </div>
    <button class="btn" onclick="generateGeniallyCode()">–ü–û–õ–£–ß–ò–¢–¨ –ö–û–î</button>
</header>

<div class="main">
    <div class="sidebar">
        <label>–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label>
        <select id="lang">
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="en">English</option>
            <option value="de">Deutsch</option>
            <option value="es">Espa√±ol</option>
            <option value="fr">Fran√ßais</option>
            <option value="zh">Chinese</option>
        </select>
        
        <div id="q-list"></div>
        <button class="btn btn-add" onclick="addQuestion()">+ –î–û–ë–ê–í–ò–¢–¨ –í–û–ü–†–û–°</button>
    </div>
    
    <div class="preview">
        <button class="btn btn-update" onclick="updatePreview()">üîÑ –û–ë–ù–û–í–ò–¢–¨</button>
        <div id="preview-container">
            <iframe id="game-frame"></iframe>
        </div>
    </div>
</div>

<footer>(c) –ö–æ—Ä–ø–æ—Ä–∞—Ü–∏—è –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ë—É–¥—É—â–µ–≥–æ 2026</footer>

<div id="modal" class="modal">
    <h2 style="color:white; font-family:'VT323'; font-size:36px; margin-bottom:10px;">–ö–û–î –î–õ–Ø –í–°–¢–ê–í–ö–ò (GENIALLY)</h2>
    <p style="color:#aaa; margin-bottom:15px;">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Å—ë –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ Insert -> Others. –≠—Ç–æ—Ç –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Blob, –ø–æ—ç—Ç–æ–º—É –æ–Ω –Ω–µ –æ–±—Ä–µ–∂–µ—Ç—Å—è.</p>
    <textarea id="final-code" class="code-box" readonly onclick="this.select()"></textarea>
    <button class="btn" onclick="document.getElementById('modal').style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
</div>

<script id="game-template" type="text/plain">
<!DOCTYPE html>
<html lang="{{LANG}}">
<head>
    <meta charset="UTF-8">
    <title>Minecraft Genially</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"><\/script>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'VT323', monospace; user-select: none; }
        #hud { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        
        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
        .float-text-dmg {
            position: absolute; color: #ffff55; font-size: 40px; font-weight: bold;
            text-shadow: 3px 3px 0 #000; pointer-events: none;
            animation: floatUp 1s forwards; white-space: nowrap;
        }
        .crit { color: #ff3333; font-size: 60px; text-shadow: 4px 4px 0 #000; }
        @keyframes floatUp { to { transform: translateY(-120px) scale(1.2); opacity: 0; } }

        #house-status { position: absolute; top: 100px; width: 100%; text-align: center; font-size: 30px; color: #55ff55; text-shadow: 2px 2px 0 #000; display: none; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 24px; height: 24px; transform: translate(-50%, -50%); mix-blend-mode: difference; }
        #crosshair::before { content: ''; position: absolute; top: 11px; left: 0; width: 24px; height: 2px; background: white; }
        #crosshair::after { content: ''; position: absolute; top: 0; left: 11px; width: 2px; height: 24px; background: white; }
        #bottom-ui { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 600px; text-align: center; }
        .hearts { display: flex; gap: 4px; justify-content: center; margin-bottom: 5px; }
        .heart { width: 32px; height: 32px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10"><path fill="%23ff0000" stroke="black" stroke-width="0.5" d="M2 1h2v1h2V1h2v2H7v1H6v1H5v1H4V5H3V4H2V2h2z"/></svg>'); background-size: contain; image-rendering: pixelated; }
        .heart.lost { filter: grayscale(100%) brightness(0.3); }
        #xp-bar { width: 100%; height: 16px; background: #222; border: 3px solid #000; position: relative; margin-bottom: 10px; }
        #xp-fill { height: 100%; background: linear-gradient(to right, #00ff00, #55ff55); width: 0%; transition: width 0.2s; }
        #xp-info { position: absolute; top: -35px; width: 100%; color: #80ff00; font-size: 30px; text-shadow: 2px 2px 0 #000; display: flex; justify-content: space-around; }
        #hotbar { display: flex; justify-content: center; gap: 4px; background: rgba(0,0,0,0.6); padding: 5px; border: 2px solid #fff; border-radius: 4px; }
        .slot { width: 60px; height: 60px; background: #8b8b8b; border: 4px solid #373737; border-top-color: #ddd; border-left-color: #ddd; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; }
        .slot.active { border-color: white; background: #a0a0a0; transform: scale(1.1); }
        
        #quest-box { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 15px 40px; border: 3px solid #fff; color: white; text-align: center; min-width: 300px; }
        #q-text { font-size: 32px; color: #ffff55; text-shadow: 2px 2px 0 #333; }
        #q-img { max-height: 150px; border: 2px solid white; margin-top: 10px; display: none; }
        
        #damage-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: red; opacity: 0; pointer-events: none; transition: opacity 0.1s; }
        #fire-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 40%; background: linear-gradient(transparent, rgba(255, 100, 0, 0.5)); opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        #game-over, #win-screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 999; }
        #game-over { background: rgba(50,0,0,0.9); }
        #win-screen { background: rgba(0,50,0,0.9); }
        .btn-respawn { font-size: 40px; cursor: pointer; color: #ffff55; text-decoration: underline; margin-top: 20px; }
    </style>
</head>
<body>
<div id="damage-overlay"></div><div id="fire-overlay"></div>
<div id="hud">
    <div id="quest-box"><div id="lbl-q" style="color:#aaa;font-size:18px;letter-spacing:2px">Q</div><div id="q-text">...</div><img id="q-img" src=""></div>
    <div id="house-status"></div><div id="crosshair"></div>
    <div id="bottom-ui"><div id="xp-info"><span>XP: <span id="lvl-num">0</span></span><span style="color:#ffd700">COMBO: x<span id="combo-num">0</span></span></div><div class="hearts" id="hearts-container"><div class="heart"></div><div class="heart"></div><div class="heart"></div><div class="heart"></div><div class="heart"></div></div><div id="xp-bar"><div id="xp-fill"></div></div><div id="hotbar"><div class="slot active" id="slot-0">üî´</div><div class="slot" id="slot-1"></div></div></div>
</div>
<div id="game-over"><h1 id="lbl-died" style="font-size:100px;margin:0;color:#ff5555">YOU DIED</h1><p class="btn-respawn" onclick="location.reload()">Respawn</p></div>
<div id="win-screen"><h1 id="lbl-win" style="font-size:80px;margin:0;color:#55ff55">QUEST COMPLETE!</h1><div id="win-stats" style="font-size:35px;text-align:center;margin:20px"></div><p class="btn-respawn" onclick="location.reload()">Play Again</p></div>

<script>
// --- CONFIG INJECTION ---
const config = {{CONFIG_JSON}};

// --- TRANSLATIONS ---
const tr={ru:{q:"–¢–ï–ö–£–©–ò–ô –í–û–ü–†–û–°",safe:"üõ°Ô∏è –í –£–ö–†–´–¢–ò–ò",done:"–í—ã –ø—Ä–æ—à–ª–∏!"},en:{q:"CURRENT QUESTION",safe:"üõ°Ô∏è SAFE ZONE",done:"Well done!"},de:{q:"FRAGE",safe:"SICHERHEIT",done:"Gut!"},fr:{q:"QUESTION",safe:"ZONE S√õRE",done:"Bien!"},es:{q:"PREGUNTA",safe:"ZONA SEGURA",done:"¬°Bien!"},zh:{q:"ÈóÆÈ¢ò",safe:"ÂÆâÂÖ®Âå∫",done:"Â•Ω!"}};
const t=tr[config.lang]||tr.en;
document.getElementById("lbl-q").innerText=t.q;document.getElementById("house-status").innerText=t.safe;document.getElementById("lbl-died").innerText=t.dead||"YOU DIED";document.getElementById("lbl-win").innerText=t.win||"WIN";

// --- GAME VARS ---
let scene,camera,renderer,weaponGroup,flash,score=0,currentQ=0,health=5,combo=0;
let targets=[],particles=[],bonuses=[],items=[],projectiles=[],houses=[];
let move={fwd:false,bwd:false,left:false,right:false,sprint:false,jump:false};
let player={vel:new THREE.Vector3(),onGround:false,speed:0};
let pitch=0,yaw=0,isDead=false,isWin=false,isSwinging=false,swingProgress=0;
let currentWeaponType="gun",inventory=["gun"];
const clock=new THREE.Clock();const audioCtx=new(window.AudioContext||window.webkitAudioContext)();

function createTexture(type){
    const canvas=document.createElement("canvas");canvas.width=64;canvas.height=64;const ctx=canvas.getContext("2d");
    const fillNoise=(c)=>{ctx.fillStyle=c;ctx.fillRect(0,0,64,64);for(let i=0;i<400;i++){ctx.fillStyle="rgba(0,0,0,0.1)";ctx.fillRect(Math.random()*64,Math.random()*64,4,4)}};
    if(type==="grass_top"){fillNoise("#5da34b");ctx.fillStyle="#4a8f3a";for(let i=0;i<50;i++)ctx.fillRect(Math.random()*60,Math.random()*60,4,4)}
    else if(type==="side"){fillNoise("#6d4e34");ctx.fillStyle="#5da34b";ctx.fillRect(0,0,64,15)}
    else if(type==="wood"){ctx.fillStyle="#5c4033";ctx.fillRect(0,0,64,64);ctx.fillStyle="#4a332a";for(let i=1;i<4;i++)ctx.fillRect(i*16,0,4,64)}
    else if(type==="planks"){ctx.fillStyle="#a07040";ctx.fillRect(0,0,64,64);ctx.fillStyle="#805020";ctx.fillRect(0,0,64,2);ctx.fillRect(0,20,64,2);ctx.fillRect(0,40,64,2)}
    else if(type==="face"){fillNoise("#bcaea5");ctx.fillStyle="#222";ctx.fillRect(10,20,12,12);ctx.fillRect(42,20,12,12);ctx.fillStyle="#633";ctx.fillRect(20,45,24,8)}
    else if(type==="leaves"){fillNoise("#2d5a27");ctx.fillStyle="#3e7a37";for(let i=0;i<60;i++)ctx.fillRect(Math.random()*60,Math.random()*60,6,6)}
    else if(type==="chest"){ctx.fillStyle="#6d4e34";ctx.fillRect(0,0,64,64);ctx.fillStyle="#000";ctx.strokeRect(2,2,60,60);ctx.fillStyle="#FFD700";ctx.fillRect(28,24,8,12)}
    else if(type==="skel_body"){ctx.fillStyle="#333";ctx.fillRect(0,0,64,64);ctx.fillStyle="#ddd";ctx.fillRect(28,0,8,64);for(let i=10;i<50;i+=10)ctx.fillRect(10,i,44,4)}
    else if(type==="skel_face"){ctx.fillStyle="#ccc";ctx.fillRect(0,0,64,64);ctx.fillStyle="#111";ctx.fillRect(10,20,16,14);ctx.fillRect(38,20,16,14);ctx.fillRect(28,40,8,8);ctx.fillStyle="#555";ctx.fillRect(10,55,44,4)}
    const tex=new THREE.CanvasTexture(canvas);tex.magFilter=THREE.NearestFilter;return tex;
}
const textures={grass:createTexture("grass_top"),side:createTexture("side"),wood:createTexture("wood"),planks:createTexture("planks"),face:createTexture("face"),leaves:createTexture("leaves"),chest:createTexture("chest"),skel_body:createTexture("skel_body"),skel_face:createTexture("skel_face")};

function playSound(type){
    if(audioCtx.state==="suspended")audioCtx.resume();
    const t=audioCtx.currentTime; const g=audioCtx.createGain();g.connect(audioCtx.destination);
    const osc=audioCtx.createOscillator();osc.connect(g);
    if(type==="shoot"){osc.type="sawtooth";osc.frequency.setValueAtTime(1200,t);osc.frequency.exponentialRampToValueAtTime(100,t+0.15);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.15);osc.start();osc.stop(t+0.15)}
    else if(type==="hit"){osc.type="sawtooth";osc.frequency.setValueAtTime(100,t);g.gain.setValueAtTime(0.5,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);osc.start();osc.stop(t+0.2)}
    else if(type==="loot"){osc.type="sine";osc.frequency.setValueAtTime(1200,t);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);osc.start();osc.stop(t+0.5)}
    else if(type==="break"){osc.type="sawtooth";osc.frequency.setValueAtTime(50,t);g.gain.setValueAtTime(0.8,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.4);osc.start();osc.stop(t+0.4)}
}

function init(){
    scene=new THREE.Scene();scene.background=new THREE.Color(0x87CEEB);scene.fog=new THREE.Fog(0x87CEEB,20,80);
    camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.1,1000);camera.rotation.order="YXZ";
    weaponGroup=new THREE.Group();scene.add(weaponGroup);
    renderer=new THREE.WebGLRenderer({antialias:false});renderer.setSize(window.innerWidth,window.innerHeight);
    renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;document.body.appendChild(renderer.domElement);
    const amb=new THREE.AmbientLight(0xffffff,0.5);scene.add(amb);
    const sun=new THREE.DirectionalLight(0xffffff,0.8);sun.position.set(50,100,50);sun.castShadow=true;sun.shadow.mapSize.width=2048;sun.shadow.mapSize.height=2048;scene.add(sun);
    const floor=new THREE.Mesh(new THREE.PlaneGeometry(300,300),new THREE.MeshLambertMaterial({map:textures.grass}));
    floor.rotation.x=-Math.PI/2;floor.receiveShadow=true;floor.material.map.wrapS=floor.material.map.wrapT=THREE.RepeatWrapping;floor.material.map.repeat.set(100,100);scene.add(floor);
    createHouse(20,0,20);createHouse(-30,0,-30);createHouse(40,0,-10);
    for(let i=0;i<40;i++){const x=Math.random()*200-100;const z=Math.random()*200-100;let bad=false;houses.forEach(h=>{if(new THREE.Vector3(x,0,z).distanceTo(h.pos)<8)bad=true});if(!bad&&(Math.abs(x)>10||Math.abs(z)>10))createTree(x,z)}
    setWeapon("gun");spawnLoot();loadQuestion();
    document.addEventListener("keydown",e=>{if(isDead||isWin)return;if(e.key==="1")setWeapon("gun");if(e.key==="2"&&inventory.includes("sword"))setWeapon("sword");if(e.code==="Space")move.jump=true;if(e.code==="ShiftLeft")move.sprint=true;handleKeys(e.code,true)});
    document.addEventListener("keyup",e=>{if(e.code==="Space")move.jump=false;if(e.code==="ShiftLeft")move.sprint=false;handleKeys(e.code,false)});
    document.addEventListener("mousedown",attack);
    document.addEventListener("mousemove",e=>{if(document.pointerLockElement&&!isDead&&!isWin){yaw-=e.movementX*0.002;pitch-=e.movementY*0.002;pitch=Math.max(-1.5,Math.min(1.5,pitch));camera.rotation.set(pitch,yaw,0)}});
    window.addEventListener("resize",()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)});
    animate();
}

function createHouse(x,y,z){
    const g=new THREE.Group();
    const wm=new THREE.MeshLambertMaterial({map:textures.wood});const fm=new THREE.MeshLambertMaterial({map:textures.planks});
    const fl=new THREE.Mesh(new THREE.BoxGeometry(7,0.2,7),fm);fl.position.y=0.1;g.add(fl);
    const w1=new THREE.Mesh(new THREE.BoxGeometry(7,4,0.5),wm);w1.position.set(0,2,-3.5);g.add(w1);
    const w2=new THREE.Mesh(new THREE.BoxGeometry(7,4,0.5),wm);w2.position.set(0,2,3.5);g.add(w2);
    const w3=new THREE.Mesh(new THREE.BoxGeometry(0.5,4,7),wm);w3.position.set(-3.5,2,0);g.add(w3);
    const w4a=new THREE.Mesh(new THREE.BoxGeometry(0.5,4,2.5),wm);w4a.position.set(3.5,2,-2.25);g.add(w4a);
    const w4b=new THREE.Mesh(new THREE.BoxGeometry(0.5,4,2.5),wm);w4b.position.set(3.5,2,2.25);g.add(w4b);
    const rf=new THREE.Mesh(new THREE.ConeGeometry(6,3,4),new THREE.MeshLambertMaterial({color:0x5a3a22}));rf.position.y=5.5;rf.rotation.y=Math.PI/4;g.add(rf);
    g.position.set(x,y,z);scene.add(g);
    houses.push({pos:new THREE.Vector3(x,y,z),hp:15,bounds:{minX:x-3.8,maxX:x+3.8,minZ:z-3.8,maxZ:z+3.8}});
}
function createTree(x,z){const g=new THREE.Group();const t=new THREE.Mesh(new THREE.BoxGeometry(1,5,1),new THREE.MeshLambertMaterial({map:textures.wood}));t.position.y=2.5;t.castShadow=true;g.add(t);const lm=new THREE.MeshLambertMaterial({map:textures.leaves,color:0x2d5a27});const lg=new THREE.BoxGeometry(1,1,1);for(let i=-2;i<=2;i++)for(let j=0;j<=2;j++)for(let k=-2;k<=2;k++)if(Math.abs(i)+Math.abs(j)+Math.abs(k)<4){const l=new THREE.Mesh(lg,lm);l.position.set(i,4+j,k);g.add(l)}g.position.set(x,0,z);scene.add(g)}

function setWeapon(t){
    currentWeaponType=t;weaponGroup.clear();
    document.querySelectorAll(".slot").forEach(s=>s.classList.remove("active"));
    document.getElementById(t==="gun"?"slot-0":"slot-1").classList.add("active");
    if(t==="gun"){const b=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,0.8),new THREE.MeshLambertMaterial({color:0x333}));flash=new THREE.PointLight(0xffaa00,0,4);flash.position.z=-1;weaponGroup.add(b,flash);weaponGroup.userData={offset:new THREE.Vector3(0.4,-0.4,-0.6)}}
    else{const b=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.8,0.05),new THREE.MeshLambertMaterial({color:0x88ccff}));b.position.y=0.5;weaponGroup.add(b);weaponGroup.userData={offset:new THREE.Vector3(0.5,-0.5,-0.8)}}
}

function spawnLoot(){
    const cg=new THREE.BoxGeometry(0.8,0.8,0.8);const cm=new THREE.MeshLambertMaterial({map:textures.chest});
    for(let i=0;i<8;i++){const b=new THREE.Mesh(cg,cm);b.position.set(Math.random()*80-40,0.4,Math.random()*80-40);b.userData={type:"chest"};scene.add(b);bonuses.push(b)}
    const sw=new THREE.Group();const b=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.8,0.05),new THREE.MeshLambertMaterial({color:0x88ccff}));b.position.y=0.4;sw.add(b);sw.position.set(5,0.5,5);sw.rotation.z=Math.PI/2;sw.userData={type:"sword_item"};scene.add(sw);items.push(sw);
}

function renderText(el,txt){if(txt.includes("$")){try{katex.render(txt.replace(/\$/g,""),el,{throwOnError:false})}catch(e){el.innerText=txt}}else{el.innerText=txt}}

function createMob(txt,type){
    const m=new THREE.Group();const isSkel=type==="skeleton";
    const skin=isSkel?0xdddddd:0x5D995D;const tf=isSkel?textures.skel_face:textures.face;
    const ms=new THREE.MeshLambertMaterial({color:skin});const mc=new THREE.MeshLambertMaterial({color:isSkel?0xcccccc:0x3C50C4});
    const hm=[ms,ms,ms,ms,new THREE.MeshLambertMaterial({map:tf}),ms];
    const body=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.75,0.25),isSkel?new THREE.MeshLambertMaterial({map:textures.skel_body}):mc);body.position.y=1.125;
    const head=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5),hm);head.position.y=1.75;
    const armL=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.75,0.15),ms);armL.position.set(-0.35,1.5,0);
    const armR=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.75,0.15),ms);armR.position.set(0.35,1.5,0);
    const legL=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.75,0.15),ms);legL.position.set(-0.15,0.75,0);
    const legR=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.75,0.15),ms);legR.position.set(0.15,0.75,0);
    m.add(body,head,armL,armR,legL,legR);m.castShadow=true;

    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–î–ü–ò–°–ï–ô ---
    if(txt.startsWith("http")){
        const map=new THREE.TextureLoader().load(txt);map.magFilter=THREE.NearestFilter;
        const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:map}));sp.scale.set(1.5,1.5,1);sp.position.y=2.6;m.add(sp);
    } else {
        const d=document.createElement("div");
        // –°—Ç–∞—Ç–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ (–±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è)
        d.style.position="absolute";d.style.color="#ffff55";d.style.fontSize="40px";d.style.fontWeight="bold";d.style.textShadow="2px 2px 0 #000";d.style.pointerEvents="none";d.style.whiteSpace="nowrap";
        renderText(d,txt);document.body.appendChild(d);m.userData.label=d;
    }

    if(isSkel){const bow=new THREE.Group();const b=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.4,0.1),new THREE.MeshLambertMaterial({color:0x5c4033}));bow.add(b);bow.position.set(0,-0.4,0.2);armR.add(bow);armL.rotation.x=-Math.PI/2;armR.rotation.x=-Math.PI/2}
    m.userData={parts:{armL,armR,legL,legR,body,head},isAggro:false,aggroTimer:0,type:type||"zombie",shotTimer:0};return m;
}

function loadQuestion(){
    if(currentQ>=config.questions.length){isWin=true;document.exitPointerLock();document.getElementById("win-screen").style.display="flex";document.getElementById("win-stats").innerHTML=t.done+" Score: "+score;return}
    targets.forEach(t=>{scene.remove(t.obj);if(t.obj.userData.label)t.obj.userData.label.remove()});targets=[];
    const q=config.questions[currentQ];
    const qt=document.getElementById("q-text");const qi=document.getElementById("q-img");
    if(q.q.startsWith("http")){qt.style.display="none";qi.src=q.q;qi.style.display="block"}else{qt.style.display="block";qi.style.display="none";renderText(qt,q.q)}
    q.a.forEach((ans,i)=>{
        const m=createMob(ans,Math.random()>0.5?"zombie":"skeleton");
        const a=(i*(Math.PI*2/q.a.length))+(Math.random()*0.5);const r=22;m.position.set(Math.cos(a)*r,0,Math.sin(a)*r);
        scene.add(m);targets.push({obj:m,isC:i===q.c,angle:Math.random()*10});
    });
}

function spawnFloat(x,y,z,txt,col){
    const d=document.createElement("div");d.className="float-text-dmg";d.innerText=txt;d.style.color=col;
    if(txt==="CRIT!")d.classList.add("crit");document.body.appendChild(d);
    const v=new THREE.Vector3(x,y+2,z);v.project(camera);
    const cx=(v.x*.5+.5)*window.innerWidth;const cy=(-(v.y*.5)+.5)*window.innerHeight;
    d.style.left=cx+"px";d.style.top=cy+"px";setTimeout(()=>d.remove(),1000);
}

function attack(){
    if(isDead||isWin||isSwinging)return;isSwinging=true;swingProgress=0;
    if(currentWeaponType==="gun"){playSound("shoot");if(flash){flash.intensity=2;setTimeout(()=>flash.intensity=0,50)}}else{playSound("sword_hit")}
    const ray=new THREE.Raycaster();ray.setFromCamera(new THREE.Vector2(0,0),camera);
    const hits=ray.intersectObjects(scene.children,true);
    if(hits.length>0){
        let hit=hits[0].object;let root=hit;while(root.parent&&root.parent.type!=="Scene")root=root.parent;
        if(bonuses.includes(root)){playSound("loot");scene.remove(root);bonuses=bonuses.filter(b=>b!==root);score+=200;document.getElementById("lvl-num").innerText=score;spawnFloat(root.position.x,root.position.y,root.position.z,"+200","#ffff00");return}
        if(items.includes(root)){playSound("loot");scene.remove(root);items=items.filter(i=>i!==root);if(root.userData.type==="sword_item"){inventory.push("sword");document.getElementById("slot-1").innerText="üó°Ô∏è"}return}
        while(hit.parent&&hit.type!=="Group")hit=hit.parent;
        const t=targets.find(x=>x.obj===hit);
        if(t){
            const d=hit.position.distanceTo(camera.position);
            if((currentWeaponType==="gun"&&d>40)||(currentWeaponType==="sword"&&d>6))return;
            const hs=hits[0].object===t.obj.userData.parts.head;
            if(t.isC){
                let p=100+(combo*50);if(hs){p*=2;spawnFloat(hit.position.x,hit.position.y,hit.position.z,"CRIT!","#ff3333")}else{spawnFloat(hit.position.x,hit.position.y,hit.position.z,"+"+p,"#00ff00")}
                score+=p;combo++;document.getElementById("lvl-num").innerText=score;document.getElementById("combo-num").innerText=combo;
                currentQ++;loadQuestion();
            }else{combo=0;document.getElementById("combo-num").innerText=0;t.obj.userData.isAggro=true;t.obj.userData.aggroTimer=10;t.obj.userData.parts.body.material.color.set(0xff0000)}
        }
    }
}

function takeDamage(){
    if(isDead||isWin)return;const h=checkHouse(camera.position);if(h)return;
    const now=Date.now();if(now-lastDamageTime<1000)return;lastDamageTime=now;playSound("hit");health--;
    const hearts=document.querySelectorAll(".heart");if(hearts[health])hearts[health].classList.add("lost");
    const hud=document.getElementById("hud");hud.classList.add("shake");setTimeout(()=>hud.classList.remove("shake"),500);
    document.getElementById("damage-overlay").style.opacity=0.6;setTimeout(()=>document.getElementById("damage-overlay").style.opacity=0,300);
    if(health<=0){isDead=true;document.getElementById("game-over").style.display="flex";document.exitPointerLock()}
}

function checkHouse(p){for(let h of houses)if(h.hp>0&&p.x>h.bounds.minX+0.5&&p.x<h.bounds.maxX-0.5&&p.z>h.bounds.minZ+0.5&&p.z<h.bounds.maxZ-0.5)return h;return null}
function handleKeys(c,s){if(c==="KeyW")move.fwd=s;if(c==="KeyS")move.bwd=s;if(c==="KeyA")move.left=s;if(c==="KeyD")move.right=s}
function onMouseMove(e){if(document.pointerLockElement&&!isDead&&!isWin){yaw-=e.movementX*0.002;pitch-=e.movementY*0.002;pitch=Math.max(-1.5,Math.min(1.5,pitch));camera.rotation.set(pitch,yaw,0)}}

function animate(){
    requestAnimationFrame(animate);if(isDead||isWin)return;
    const dt=clock.getDelta();const now=Date.now()/1000;
    player.speed=move.sprint?18:10;
    const dir=new THREE.Vector3();const fwd=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);fwd.y=0;fwd.normalize();const rgt=new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);rgt.y=0;rgt.normalize();
    if(move.fwd)dir.add(fwd);if(move.bwd)dir.sub(fwd);if(move.left)dir.sub(rgt);if(move.right)dir.add(rgt);
    if(dir.length()>0)dir.normalize().multiplyScalar(player.speed*dt);
    if(player.onGround&&move.jump){player.vel.y=12;player.onGround=false}player.vel.y-=30*dt;
    let nx=camera.position.x+(dir.x+player.vel.x*dt);let nz=camera.position.z+(dir.z+player.vel.z*dt);
    let cx=true,cz=true;
    for(let h of houses){
        if(nx>h.bounds.minX-0.8&&nx<h.bounds.maxX+0.8&&camera.position.z>h.bounds.minZ-0.8&&camera.position.z<h.bounds.maxZ+0.8)cx=false;
        if(camera.position.x>h.bounds.minX&&camera.position.x<h.bounds.maxX&&nz>h.bounds.minZ-0.8&&nz<h.bounds.maxZ+0.8)cz=false;
        // Door logic simplified
        if(nx>h.bounds.minX&&nx<h.bounds.maxX&&camera.position.z>h.pos.z+2.5&&camera.position.z<h.pos.z+3.5)cx=true;
    }
    if(cx)camera.position.x=nx;if(cz)camera.position.z=nz;
    camera.position.y+=player.vel.y*dt;if(camera.position.y<1.7){camera.position.y=1.7;player.vel.y=0;player.onGround=true}
    player.vel.x*=0.9;player.vel.z*=0.9;
    
    document.getElementById("house-status").style.display=checkHouse(camera.position)?"block":"none";
    
    const off=weaponGroup.userData.offset||new THREE.Vector3(0.5,-0.5,-0.8);
    weaponGroup.position.copy(camera.position);weaponGroup.quaternion.copy(camera.quaternion);
    weaponGroup.translateX(off.x);weaponGroup.translateY(off.y+(move.fwd||move.bwd?Math.sin(now*(move.sprint?18:12))*0.03:0));weaponGroup.translateZ(off.z);
    if(isSwinging){swingProgress+=dt*15;if(swingProgress>=Math.PI){swingProgress=0;isSwinging=false;weaponGroup.rotation.x=0}else{if(currentWeaponType==="gun")weaponGroup.position.z+=Math.sin(swingProgress)*0.1;else weaponGroup.rotateX(-Math.sin(swingProgress))}}else{weaponGroup.rotateX(currentWeaponType!=="gun"?Math.PI/8:0)}

    targets.forEach(t=>{
        const m=t.obj;const d=m.position.distanceTo(camera.position);
        if(m.userData.label){
            const pos=m.position.clone().add(new THREE.Vector3(0,2.5,0));pos.project(camera);
            const x=(pos.x*.5+.5)*window.innerWidth;const y=-(pos.y*.5-.5)*window.innerHeight;
            m.userData.label.style.left=(x-m.userData.label.clientWidth/2)+"px";
            m.userData.label.style.top=y+"px";
            m.userData.label.style.display=(pos.z<1&&d<40)?"block":"none";
        }
        if(m.userData.isAggro){
            m.lookAt(camera.position.x,0,camera.position.z);
            if(d>2.5)m.translateZ(6*dt);else takeDamage();
        }else{
            if(d>30)m.lookAt(0,0,0);m.translateZ(1.5*dt);m.rotation.y+=Math.sin(now*0.5+t.angle)*0.01;
        }
        const p=m.userData.parts;const w=Math.sin(now*10);
        if(m.userData.type!=="skeleton"){p.armL.rotation.x=w;p.armR.rotation.x=-w}
        p.legL.rotation.x=-w;p.legR.rotation.x=w;
    });
    renderer.render(scene,camera);
}
document.body.addEventListener("click",()=>{if(audioCtx.state==="suspended")audioCtx.resume();if(!isDead&&!isWin)document.body.requestPointerLock()});
init();
<\/script>
</body>
</html>
</script>

<script>
    // --- EDITOR SCRIPT ---
    let questions = [{ q: "2 + 2 = $4$", a: ["$4$", "$5$", "$6$"], c: 0 }];

    function renderList() {
        const c = document.getElementById('q-list');
        c.innerHTML = '';
        questions.forEach((q, i) => {
            let ansHtml = '';
            q.a.forEach((ans, ai) => {
                ansHtml += `
                <div class="ans-row">
                    <input type="radio" name="q${i}" ${q.c === ai ? 'checked' : ''} onchange="updQ(${i}, 'c', ${ai})">
                    <input type="text" value="${ans.replace(/"/g, '&quot;')}" oninput="updQ(${i}, 'a', ${ai}, this.value)" placeholder="–û—Ç–≤–µ—Ç ${ai+1}">
                </div>`;
            });
            c.innerHTML += `
            <div class="q-card">
                <button class="btn-del" onclick="delQ(${i})">X</button>
                <label>–í–æ–ø—Ä–æ—Å ${i+1}</label>
                <input type="text" value="${q.q.replace(/"/g, '&quot;')}" oninput="updQ(${i}, 'q', null, this.value)" placeholder="–¢–µ–∫—Å—Ç, —Ñ–æ—Ä–º—É–ª–∞ ($...$) –∏–ª–∏ —Å—Å—ã–ª–∫–∞">
                <label style="margin-top:10px;">–í–∞—Ä–∏–∞–Ω—Ç—ã (–ú–æ–±—ã)</label>
                ${ansHtml}
            </div>`;
        });
    }

    function addQuestion() { questions.push({ q: "–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å", a: ["A", "B", "C"], c: 0 }); renderList(); }
    function delQ(i) { if(questions.length > 1) { questions.splice(i, 1); renderList(); } }
    function updQ(i, type, idx, val) {
        if(type === 'q') questions[i].q = val;
        if(type === 'c') questions[i].c = idx;
        if(type === 'a') questions[i].a[idx] = val;
    }

    // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–±–∏—Ä–∞–µ—Ç HTML –∏–≥—Ä—ã
    function buildGameHTML() {
        const lang = document.getElementById('lang').value;
        const config = { lang: lang, questions: questions };
        // –ë–µ—Ä–µ–º —à–∞–±–ª–æ–Ω –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
        let template = document.getElementById('game-template').innerHTML;
        // –í—Å—Ç–∞–≤–ª—è–µ–º JSON –∫–æ–Ω—Ñ–∏–≥
        template = template.replace('{{CONFIG_JSON}}', JSON.stringify(config));
        // –í—Å—Ç–∞–≤–ª—è–µ–º –Ø–∑—ã–∫
        template = template.replace('{{LANG}}', lang);
        return template;
    }

    function updatePreview() {
        const html = buildGameHTML();
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        document.getElementById('game-frame').src = url;
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è Genially
    function generateGeniallyCode() {
        // –ú—ã –±–µ—Ä–µ–º –í–ï–°–¨ –∫–æ–¥ –∏–≥—Ä—ã –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –∏ —Å–ª—ç—à–∏, —á—Ç–æ–±—ã –≤—Å—Ç–∞–≤–∏—Ç—å –≤ JS –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        let gameCode = buildGameHTML();
        // –°–∞–º—ã–π –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç: —Å–æ–∑–¥–∞–µ–º –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—Å—Ç Blob –≤–Ω—É—Ç—Ä–∏ Genially
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º backticks (``) –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–π —Å—Ç—Ä–æ–∫–∏, –ø–æ—ç—Ç–æ–º—É —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∏—Ö –≤–Ω—É—Ç—Ä–∏ –∫–æ–¥–∞
        gameCode = gameCode.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\${/g, '\\${');

        const geniallyCode = `
<iframe id="game-frame" style="width:100%; height:100vh; border:none;" allow="autoplay; pointer-lock"></iframe>
<script>
const gameCode = \`${gameCode}\`;
const blob = new Blob([gameCode], { type: 'text/html' });
const url = URL.createObjectURL(blob);
document.getElementById('game-frame').src = url;
<\/script>
        `.trim();

        document.getElementById('final-code').value = geniallyCode;
        document.getElementById('modal').style.display = 'flex';
    }

    // Start
    renderList();
    updatePreview();
</script>
</body>
</html>
